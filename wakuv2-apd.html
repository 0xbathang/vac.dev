<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>Waku v2 Ambient Peer Discovery</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="description" content="Introducing and discussing ambient peer discovery methods currently used by Waku v2, as well as future plans in this area."/><link rel="shortcut icon" href="/assets/logo/vac/favicon.ico"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:creator" content="vacp2p"/><meta name="twitter:site" content="@vacp2p"/><meta name="twitter:title" content="Waku v2 Ambient Peer Discovery"/><meta name="twitter:description" content="Introducing and discussing ambient peer discovery methods currently used by Waku v2, as well as future plans in this area."/><meta name="twitter:image" content="https://staging.vac.dev/compiled-assets/img/waku_v2_discv5_random_walk_estimation.svg"/><meta property="og:url" content="https://staging.vac.dev//wakuv2-apd"/><meta property="og:image" content="https://staging.vac.dev/compiled-assets/img/waku_v2_discv5_random_walk_estimation.svg"/><meta property="og:site_name" content="Waku v2 Ambient Peer Discovery"/><meta property="og:title" content="Waku v2 Ambient Peer Discovery"/><meta property="og:description" content="Introducing and discussing ambient peer discovery methods currently used by Waku v2, as well as future plans in this area."/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/e068b41030ceede6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e068b41030ceede6.css" data-n-g=""/><link rel="preload" href="/_next/static/css/cdd95df0746869ac.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cdd95df0746869ac.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script defer="" src="/_next/static/chunks/440.30d6564577c1ada0.js"></script><script src="/_next/static/chunks/webpack-a14325fd952bf0eb.js" defer=""></script><script src="/_next/static/chunks/framework-fc97f3f1282ce3ed.js" defer=""></script><script src="/_next/static/chunks/main-ada0258e433ba222.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5af98ad241d466a2.js" defer=""></script><script src="/_next/static/chunks/eb1842f2-90eb16656390ba2a.js" defer=""></script><script src="/_next/static/chunks/399-b4b9981c243e7c94.js" defer=""></script><script src="/_next/static/chunks/22-651cfaa0b9f0d072.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...path%5D%5D-e5cc32395b198f36.js" defer=""></script><script src="/_next/static/_Gqh1sHcXYOQBFtsjeOtT/_buildManifest.js" defer=""></script><script src="/_next/static/_Gqh1sHcXYOQBFtsjeOtT/_ssgManifest.js" defer=""></script><script src="/_next/static/_Gqh1sHcXYOQBFtsjeOtT/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><svg width="0" height="0" xmlns="http://www.w3.org/2000/svg" style="display:none"><defs><filter id="colored"><feColorMatrix type="matrix" values="1.00 0 0 0 0 0 1.00 0 0 0 0 0 1.00 0 0 0 0 0 1 0"></feColorMatrix></filter></defs></svg><style nonce="logos">
      #nprogress {
        pointer-events: none;
      }
      #nprogress .bar {
        background: #000000;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
      }
      #nprogress .peg {
        display: block;
        position: absolute;
        right: 0px;
        width: 100px;
        height: 100%;
        box-shadow: 0 0 10px #000000, 0 0 5px #000000;
        opacity: 1;
        -webkit-transform: rotate(3deg) translate(0px, -4px);
        -ms-transform: rotate(3deg) translate(0px, -4px);
        transform: rotate(3deg) translate(0px, -4px);
      }
      #nprogress .spinner {
        display: block;
        position: fixed;
        z-index: 1031;
        top: 15px;
        right: 15px;
      }
      #nprogress .spinner-icon {
        width: 18px;
        height: 18px;
        box-sizing: border-box;
        border: solid 2px transparent;
        border-top-color: #000000;
        border-left-color: #000000;
        border-radius: 50%;
        -webkit-animation: nprogresss-spinner 400ms linear infinite;
        animation: nprogress-spinner 400ms linear infinite;
      }
      .nprogress-custom-parent {
        overflow: hidden;
        position: relative;
      }
      .nprogress-custom-parent #nprogress .spinner,
      .nprogress-custom-parent #nprogress .bar {
        position: absolute;
      }
      @-webkit-keyframes nprogress-spinner {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes nprogress-spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style><div class="Style_container__qv2Yk Styles_common_container__u_XHj template-container"><header class="Styles_container__5FUI_ Style_header__IYvBP undefined"><div class="Styles_innerWrapper__ZInvp"><div class="logo-holder button vac" style="display:inline-block"><svg width="45" height="43" viewBox="0 0 35 43" fill="none" xmlns="http://www.w3.org/2000/svg" class="vac-logo"><g clip-path="url(#clip0_917_3082)"><path d="M24.9034 14.8217C24.6824 11.2666 23.5308 7.8298 21.5623 4.84994C22.543 4.19721 23.7374 3.93844 24.9034 4.12603C25.492 4.23064 26.0472 4.4722 26.5233 4.83086C26.9994 5.18951 27.3828 5.65504 27.6421 6.18916C28.0141 7.1512 28.1335 8.19117 27.989 9.21147C27.9754 9.6728 27.8955 10.1299 27.7516 10.5688C27.6613 10.8504 27.5322 11.1183 27.3682 11.3651C27.166 11.69 26.9466 12.0041 26.7109 12.3062C26.1084 13.1206 25.5607 14.0073 24.9034 14.8217Z" fill="#999999"></path><path d="M16.7058 7.58268C15.8382 5.99003 14.5344 4.67263 12.9447 3.78217L10.9546 2.69631C10.9546 2.69631 13.2551 -0.778436 16.1945 0.162641C19.134 1.10372 18.1846 7.4017 17.5821 9.80869" fill="#4D4D4D"></path><path d="M20.3209 41.6243C17.4179 40.4118 16.2129 38.3668 14.6975 36.919C13.1821 35.4711 12.8717 29.3903 13.1638 24.6126C13.456 19.8348 17.4909 11.528 17.5822 9.80869C17.6735 8.08941 15.4643 5.17569 13.5655 3.78217C11.6491 2.2631 9.29769 1.38272 6.84668 1.2666L8.36207 2.51534C9.74965 3.67359 9.42101 3.98125 9.22018 6.26155C9.01935 8.54185 8.72722 15.6904 8.70896 21.8436C8.70896 30.3495 6.73713 32.7022 13.0178 38.8373C14.1564 40.1358 15.6863 41.0368 17.3814 41.4072C21.6902 43.036 24.228 43.2712 20.3209 41.6243Z" fill="#1A1A1A"></path><path d="M17.9839 7.07618C17.5904 9.58823 16.8212 12.0281 15.7016 14.3152C14.6765 16.6746 13.7925 19.0918 13.0543 21.5543C12.076 25.3846 11.8405 29.3642 12.3605 33.2816C12.4325 34.6426 12.8065 35.9712 13.4559 37.1726C14.1362 38.1272 14.9759 38.9596 15.939 39.6338C17.8321 41.3312 20.1651 42.4718 22.6761 42.9276C20.068 40.8547 18.189 38.0165 17.3083 34.8199C16.3002 31.5246 16.6412 27.9684 18.2577 24.9205C18.7142 24.0699 19.2436 23.2555 19.7731 22.4411L24.4653 15.3287C24.7022 15.0187 24.8815 14.6694 24.9948 14.2971C25.0769 13.891 25.0769 13.4727 24.9948 13.0665C24.3347 9.48034 22.792 6.11109 20.5034 3.25758C19.9266 2.35717 19.1529 1.59688 18.2395 1.033C17.3262 0.46911 16.2966 0.116066 15.2269 0C15.7121 0.03052 16.1783 0.198543 16.5699 0.484084C16.9616 0.769625 17.2622 1.16066 17.4361 1.61069C17.8159 2.51034 18.0085 3.47679 18.0021 4.45202C18.0507 5.32627 18.0446 6.20267 17.9839 7.07618Z" fill="#808080"></path><path d="M34.927 21.7174C34.8742 21.5895 34.8068 21.4681 34.7261 21.3554C34.5725 21.0145 34.3893 20.6875 34.1784 20.3781C34.0141 20.1429 33.8315 19.9257 33.6489 19.7085C33.2107 19.1294 33.0829 18.3874 32.5352 17.8988C32.2726 17.6504 32.0907 17.33 32.0126 16.9787C31.9346 16.6273 31.964 16.2609 32.097 15.9261C32.2066 15.6366 32.4074 15.4013 32.5352 15.1298C32.6706 14.7258 32.7195 14.2982 32.6786 13.8744C32.6378 13.4505 32.5081 13.0398 32.2979 12.6685C31.7956 11.6016 31.1838 10.5888 30.4721 9.64624C29.5227 8.32511 28.5185 7.05828 27.4596 5.82764C27.6672 6.89431 27.6423 7.99266 27.3865 9.04902C27.2386 9.62495 27.0432 10.1879 26.8023 10.7321C26.4264 11.4007 26.0118 12.0473 25.5608 12.6685C23.2238 16.2881 20.832 19.9076 18.349 23.4004C17.0435 25.5573 16.3321 28.0161 16.2859 30.5309C16.0848 32.9993 16.618 35.472 17.8195 37.6433C18.5687 38.8742 19.4502 40.021 20.4486 41.0637C21.0694 41.7334 21.7814 42.8735 22.6395 43.0726C22.7491 42.041 22.9499 40.6475 23.096 39.6159C23.3338 37.934 23.8782 36.3089 24.7027 34.8201C25.1895 33.7601 26.0543 32.9158 27.1309 32.4493C27.9135 32.2862 28.7218 32.2862 29.5044 32.4493C29.9422 32.4221 30.3812 32.4221 30.819 32.4493C31.2686 32.4735 31.7149 32.3597 32.097 32.1235C32.3186 31.968 32.5024 31.7655 32.6351 31.5307C32.7677 31.2959 32.8459 31.0347 32.8638 30.7662C32.9186 30.2791 32.9186 29.7874 32.8638 29.3003C32.8245 28.9868 32.8685 28.6686 32.9916 28.3773C33.2473 27.8525 34.0141 27.6172 34.0689 27.02C34.0476 26.7523 33.9665 26.4927 33.8315 26.2599C33.7604 26.1456 33.7228 26.014 33.7228 25.8798C33.7228 25.7456 33.7604 25.614 33.8315 25.4998C33.8315 25.4998 34.0506 25.355 34.1236 25.2464C34.2051 25.1396 34.2492 25.0093 34.2492 24.8754C34.2492 24.7415 34.2051 24.6112 34.1236 24.5044C33.9428 24.2955 33.8006 24.0566 33.7037 23.7986C33.695 23.6656 33.715 23.5323 33.7622 23.4075C33.8094 23.2827 33.8828 23.1692 33.9776 23.0747C34.1732 22.888 34.3945 22.7295 34.6348 22.6041C34.7511 22.5516 34.8541 22.4739 34.9362 22.3769C35.0183 22.2798 35.0776 22.1658 35.1095 22.0431C35.0688 21.9246 35.0069 21.8143 34.927 21.7174Z" fill="#CCCCCC"></path><path d="M34.3062 20.5771C34.478 20.8248 34.619 21.0922 34.7261 21.3734C34.8037 21.4816 34.8709 21.5967 34.9269 21.7173L34.3062 20.5771Z" fill="#CCCCCC"></path><path d="M10.133 33.4262C9.0523 28.5693 8.7138 23.5789 9.12886 18.6223C9.12886 16.1429 11.265 2.44302 7.79605 1.41145C4.85656 0.524668 2.53783 3.94512 2.53783 3.94512C0.667683 7.68216 -0.206002 11.8316 1.36513e-05 15.9982C2.30048 38.8193 17.6735 41.4615 18.2577 41.7149C18.2577 41.7149 11.4476 39.2898 10.133 33.4262Z" fill="#09212A"></path></g><defs><clipPath id="clip0_917_3082"><rect width="35" height="43"></rect></clipPath></defs></svg></div><div class="Styles_searchBox__5X2m1"><div class="Styles_container__ddCFx "><div class="logos-search-box Styles_searchBox__xWHyX"><div><input type="text" placeholder="Search Vac Research" value=""/></div></div></div></div></div></header><div class="page-info"><h1 style="display:none">Vac Research</h1><div class="page-info-sub"><i>Apr 03 2023</i><br/><span>staging.vac.dev</span></div></div><main class="undefined Styles_common_main__4v7gP Styles_common_main__4v7gP"><aside class="Styles_container__3yUcn Style_sidebar__mLS5A Styles_common_sidebar__QAVov hidden-scroll Styles_hideDesktopToggleButton__L_Rik"><div class="sidebar-toggle-button button Styles_mobile___qAwf"><svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 4h14c.55 0 1-.45 1-1s-.45-1-1-1H1c-.55 0-1 .45-1 1s.45 1 1 1Zm14 8H1c-.55 0-1 .45-1 1s.45 1 1 1h14c.55 0 1-.45 1-1s-.45-1-1-1Zm0-5H1c-.55 0-1 .45-1 1s.45 1 1 1h14c.55 0 1-.45 1-1s-.45-1-1-1Z" fill="#F2F2F2"></path></svg></div><div class="logo-holder button vac" style="display:inline-block"><svg width="45" height="43" viewBox="0 0 35 43" fill="none" xmlns="http://www.w3.org/2000/svg" class="vac-logo"><g clip-path="url(#clip0_917_3082)"><path d="M24.9034 14.8217C24.6824 11.2666 23.5308 7.8298 21.5623 4.84994C22.543 4.19721 23.7374 3.93844 24.9034 4.12603C25.492 4.23064 26.0472 4.4722 26.5233 4.83086C26.9994 5.18951 27.3828 5.65504 27.6421 6.18916C28.0141 7.1512 28.1335 8.19117 27.989 9.21147C27.9754 9.6728 27.8955 10.1299 27.7516 10.5688C27.6613 10.8504 27.5322 11.1183 27.3682 11.3651C27.166 11.69 26.9466 12.0041 26.7109 12.3062C26.1084 13.1206 25.5607 14.0073 24.9034 14.8217Z" fill="#999999"></path><path d="M16.7058 7.58268C15.8382 5.99003 14.5344 4.67263 12.9447 3.78217L10.9546 2.69631C10.9546 2.69631 13.2551 -0.778436 16.1945 0.162641C19.134 1.10372 18.1846 7.4017 17.5821 9.80869" fill="#4D4D4D"></path><path d="M20.3209 41.6243C17.4179 40.4118 16.2129 38.3668 14.6975 36.919C13.1821 35.4711 12.8717 29.3903 13.1638 24.6126C13.456 19.8348 17.4909 11.528 17.5822 9.80869C17.6735 8.08941 15.4643 5.17569 13.5655 3.78217C11.6491 2.2631 9.29769 1.38272 6.84668 1.2666L8.36207 2.51534C9.74965 3.67359 9.42101 3.98125 9.22018 6.26155C9.01935 8.54185 8.72722 15.6904 8.70896 21.8436C8.70896 30.3495 6.73713 32.7022 13.0178 38.8373C14.1564 40.1358 15.6863 41.0368 17.3814 41.4072C21.6902 43.036 24.228 43.2712 20.3209 41.6243Z" fill="#1A1A1A"></path><path d="M17.9839 7.07618C17.5904 9.58823 16.8212 12.0281 15.7016 14.3152C14.6765 16.6746 13.7925 19.0918 13.0543 21.5543C12.076 25.3846 11.8405 29.3642 12.3605 33.2816C12.4325 34.6426 12.8065 35.9712 13.4559 37.1726C14.1362 38.1272 14.9759 38.9596 15.939 39.6338C17.8321 41.3312 20.1651 42.4718 22.6761 42.9276C20.068 40.8547 18.189 38.0165 17.3083 34.8199C16.3002 31.5246 16.6412 27.9684 18.2577 24.9205C18.7142 24.0699 19.2436 23.2555 19.7731 22.4411L24.4653 15.3287C24.7022 15.0187 24.8815 14.6694 24.9948 14.2971C25.0769 13.891 25.0769 13.4727 24.9948 13.0665C24.3347 9.48034 22.792 6.11109 20.5034 3.25758C19.9266 2.35717 19.1529 1.59688 18.2395 1.033C17.3262 0.46911 16.2966 0.116066 15.2269 0C15.7121 0.03052 16.1783 0.198543 16.5699 0.484084C16.9616 0.769625 17.2622 1.16066 17.4361 1.61069C17.8159 2.51034 18.0085 3.47679 18.0021 4.45202C18.0507 5.32627 18.0446 6.20267 17.9839 7.07618Z" fill="#808080"></path><path d="M34.927 21.7174C34.8742 21.5895 34.8068 21.4681 34.7261 21.3554C34.5725 21.0145 34.3893 20.6875 34.1784 20.3781C34.0141 20.1429 33.8315 19.9257 33.6489 19.7085C33.2107 19.1294 33.0829 18.3874 32.5352 17.8988C32.2726 17.6504 32.0907 17.33 32.0126 16.9787C31.9346 16.6273 31.964 16.2609 32.097 15.9261C32.2066 15.6366 32.4074 15.4013 32.5352 15.1298C32.6706 14.7258 32.7195 14.2982 32.6786 13.8744C32.6378 13.4505 32.5081 13.0398 32.2979 12.6685C31.7956 11.6016 31.1838 10.5888 30.4721 9.64624C29.5227 8.32511 28.5185 7.05828 27.4596 5.82764C27.6672 6.89431 27.6423 7.99266 27.3865 9.04902C27.2386 9.62495 27.0432 10.1879 26.8023 10.7321C26.4264 11.4007 26.0118 12.0473 25.5608 12.6685C23.2238 16.2881 20.832 19.9076 18.349 23.4004C17.0435 25.5573 16.3321 28.0161 16.2859 30.5309C16.0848 32.9993 16.618 35.472 17.8195 37.6433C18.5687 38.8742 19.4502 40.021 20.4486 41.0637C21.0694 41.7334 21.7814 42.8735 22.6395 43.0726C22.7491 42.041 22.9499 40.6475 23.096 39.6159C23.3338 37.934 23.8782 36.3089 24.7027 34.8201C25.1895 33.7601 26.0543 32.9158 27.1309 32.4493C27.9135 32.2862 28.7218 32.2862 29.5044 32.4493C29.9422 32.4221 30.3812 32.4221 30.819 32.4493C31.2686 32.4735 31.7149 32.3597 32.097 32.1235C32.3186 31.968 32.5024 31.7655 32.6351 31.5307C32.7677 31.2959 32.8459 31.0347 32.8638 30.7662C32.9186 30.2791 32.9186 29.7874 32.8638 29.3003C32.8245 28.9868 32.8685 28.6686 32.9916 28.3773C33.2473 27.8525 34.0141 27.6172 34.0689 27.02C34.0476 26.7523 33.9665 26.4927 33.8315 26.2599C33.7604 26.1456 33.7228 26.014 33.7228 25.8798C33.7228 25.7456 33.7604 25.614 33.8315 25.4998C33.8315 25.4998 34.0506 25.355 34.1236 25.2464C34.2051 25.1396 34.2492 25.0093 34.2492 24.8754C34.2492 24.7415 34.2051 24.6112 34.1236 24.5044C33.9428 24.2955 33.8006 24.0566 33.7037 23.7986C33.695 23.6656 33.715 23.5323 33.7622 23.4075C33.8094 23.2827 33.8828 23.1692 33.9776 23.0747C34.1732 22.888 34.3945 22.7295 34.6348 22.6041C34.7511 22.5516 34.8541 22.4739 34.9362 22.3769C35.0183 22.2798 35.0776 22.1658 35.1095 22.0431C35.0688 21.9246 35.0069 21.8143 34.927 21.7174Z" fill="#CCCCCC"></path><path d="M34.3062 20.5771C34.478 20.8248 34.619 21.0922 34.7261 21.3734C34.8037 21.4816 34.8709 21.5967 34.9269 21.7173L34.3062 20.5771Z" fill="#CCCCCC"></path><path d="M10.133 33.4262C9.0523 28.5693 8.7138 23.5789 9.12886 18.6223C9.12886 16.1429 11.265 2.44302 7.79605 1.41145C4.85656 0.524668 2.53783 3.94512 2.53783 3.94512C0.667683 7.68216 -0.206002 11.8316 1.36513e-05 15.9982C2.30048 38.8193 17.6735 41.4615 18.2577 41.7149C18.2577 41.7149 11.4476 39.2898 10.133 33.4262Z" fill="#09212A"></path></g><defs><clipPath id="clip0_917_3082"><rect width="35" height="43"></rect></clipPath></defs></svg></div><div class="Styles_desktop__VH2y3 defaultSidebar Styles_container__4YC7p"><nav class="sidebarNav hidden-scroll"><ul class="sidebar-menu mainMenu Styles_menu__izFC1"><li class="Styles_menuItem__BqRqE menuitem level-0"><span></span><ul class="sidebar-menu  Styles_menu__izFC1"><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="Main" href="/">Main</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="principles" href="/principles">Principles</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="Research areas" href="/research-areas">Research areas</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="Projects" href="/projects">Projects</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="Open Research Problems" href="/open-problems">Open Research Problems</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="publications" href="/publications">Publications</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="contribute" href="/contribute">Contribute</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="media" href="/media">Media</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li></ul><br/></li></ul><br/><ul class="sidebar-menu subMenu Styles_menu__izFC1"><li class="Styles_menuItem__BqRqE menuitem level-0"><a class="" title="research" href="/research">Research</a><ul class="sidebar-menu  Styles_menu__izFC1"><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="The Future of Waku Network: Scaling, Incentivization, and Heterogeneity" href="/future-of-waku-network">The Future of Waku Network: Scaling, Incentivization, and Heterogeneity</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="Waku for All Decentralized Applications and Infrastructures" href="/waku-for-all">Waku for All Decentralized Applications and Infrastructures</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="Building Privacy-Protecting Infrastructure" href="/building-privacy-protecting-infrastructure">Building Privacy-Protecting Infrastructure</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="Waku Privacy and Anonymity Analysis Part I: Definitions and Waku Relay" href="/wakuv2-relay-anon">Waku Privacy and Anonymity Analysis Part I: Definitions and Waku Relay</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="Noise handshakes as key-exchange mechanism for Waku" href="/wakuv2-noise">Noise handshakes as key-exchange mechanism for Waku</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="active" title="Waku v2 Ambient Peer Discovery" href="/wakuv2-apd">Waku v2 Ambient Peer Discovery</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li class="Styles_menuItem__BqRqE menuitem level-1"><a class="" title="Introducing nwaku" href="/introducing-nwaku">Introducing nwaku</a><ul class="sidebar-menu  Styles_menu__izFC1"></ul></li><li><span class="button">...</span></li></ul><br/></li></ul><div class="external_links"><div><div class="menuitem-title"><span class="cap">Resources</span></div><ul><li><a href="https://rfc.vac.dev/" target="_blank">&gt; Specs/RFCs</a></li><li><a href="https://forum.vac.dev/" target="_blank">&gt; Forum</a></li><li><a href="https://waku.org" target="_blank">&gt; Waku.org</a></li></ul></div></div></nav></div></aside><article class="Styles_container__pG0bG Style_content__NTXHZ Styles_common_content__Myi5Z"><div class="Style_container__qc2tD"><h2 class="Style_container__eSI4Q serif">Waku v2 Ambient Peer Discovery</h2><div class="serif"><i>May 09 2022</i><i> - </i>by<!-- --><a title="kaiserd" href="/authors/kaiserd"><span><i> <!-- -->kaiserd<!-- --></i></span></a></div></div><p><a href="https://rfc.vac.dev/spec/10/">Waku v2<!-- --></a> comprises a set of modular protocols for secure, privacy preserving communication.
Avoiding centralization, these protocols exchange messages over a P2P network layer.
In order to build a P2P network, participating nodes first have to discover peers within this network.
This is where <!-- --><a href="https://docs.libp2p.io/concepts/publish-subscribe/#discovery"><em>ambient peer discovery<!-- --></em></a> comes into play:
it allows nodes to find peers, making it an integral part of any decentralized application.<!-- --></p>
<!-- --><p>In this post the term <!-- --><em>node<!-- --></em> to refers to <!-- --><em>our<!-- --></em> endpoint or the endpoint that takes action,
while the term <!-- --><em>peer<!-- --></em> refers to other endpoints in the P2P network.
These endpoints can be any device connected to the Internet: e.g. servers, PCs, notebooks, mobile devices, or applications like a browser.
As such, nodes and peers are the same. We use these terms for the ease of explanation without loss of generality.<!-- --></p>
<!-- --><p>In Waku&#x27;s modular design, ambient peer discovery is an umbrella term for mechanisms that allow nodes to find peers.
Various ambient peer discovery mechanisms are supported, and each is specified as a separate protocol.
Where do these protocols fit into Waku&#x27;s protocol stack?
The P2P layer of Waku v2 builds on <!-- --><a href="https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/README.md">libp2p gossipsub<!-- --></a>.
Nodes participating in a gossipsub protocol manage a mesh network that is used for routing messages.
This mesh network is an <!-- --><a href="https://en.wikipedia.org/wiki/Peer-to-peer#Unstructured_networks">unstructured P2P network<!-- --></a>
offering high robustness and resilience against attacks.
Gossipsub implements many improvements overcoming the shortcomings typically associated with unstructured P2P networks, e.g. inefficient flooding based routing.
The gossipsub mesh network is managed in a decentralized way, which requires each node to know other participating peers.
Waku v2 may use any combination of its ambient discovery protocols to find appropriate peers.<!-- --></p>
<!-- --><p>Summarizing, Waku v2 comprises a <!-- --><em>peer management layer<!-- --></em> based on libp2p gossipsub,
which manages the peers of nodes, and an <!-- --><em>ambient peer discovery layer<!-- --></em>,
which provides information about peers to the peer management layer.<!-- --></p>
<!-- --><p>We focus on ambient peer discovery methods that are in line with our goal of building a fully decentralized, generalized, privacy-preserving and censorship-resistant messaging protocol.
Some of these protocols still need adjustments to adhere to our privacy and anonymity requirements. For now, we focus on operational stability and feasibility.
However, when choosing techniques, we pay attention to selecting mechanisms that can feasibly be tweaked for privacy in future research efforts.
Because of the modular design and the fact that Waku v2 has several discovery methods at its disposal, we could even remove a protocol in case future evaluation deems it not fitting our standards.<!-- --></p>
<!-- --><p>This post covers the current state and future considerations of ambient peer discovery for Waku v2,
and gives reason for changes and modifications we made or plan to make.
The ambient peer discovery protocols currently supported by Waku v2 are a modified version of Ethereum&#x27;s <!-- --><a href="https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5.md">Discovery v5<!-- --></a>
and <!-- --><a href="https://vac.dev/dns-based-discovery">DNS-based discovery<!-- --></a>.
Waku v2 further supports <!-- --><a href="https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange">gossipsub&#x27;s peer exchange protocol<!-- --></a>.
In addition, we plan to introduce protocols for general peer exchange and capability discovery, respectively.
The former allows resource restricted nodes to outsource querying for peers to stronger peers,
the latter allows querying peers for their supported capabilities.
Besides these new protocols, we are working on integrating capability discovery in our existing ambient peer discovery protocols.<!-- --></p>
<!-- --><h2><a class="anchor" id="static-node-lists"></a><a class="ha" href="#static-node-lists">Static Node Lists<!-- --></a></h2>
<!-- --><p>The simplest method of learning about peers in a P2P network is via static node lists.
These can be given to nodes as start-up parameters or listed in a config-file.
They can also be provided in a script-parseable format, e.g. in JSON.
While this method of providing bootstrap nodes is very easy to implement, it requires static peers, which introduce centralized elements.
Also, updating static peer information introduces significant administrative overhead:
code and/or config files have to be updated and released.
Typically, static node lists only hold a small number of bootstrap nodes, which may lead to high load on these nodes.<!-- --></p>
<!-- --><h2><a class="anchor" id="dns-based-discovery"></a><a class="ha" href="#dns-based-discovery">DNS-based Discovery<!-- --></a></h2>
<!-- --><p>Compared to static node lists,
<!-- --><a href="https://vac.dev/dns-based-discovery">DNS-based discovery<!-- --></a> (specified in <!-- --><a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459<!-- --></a>)
provides a more dynamic way of discovering bootstrap nodes.
It is very efficient, can easily be handled by resource restricted devices and provides very good availability.
In addition to a naive DNS approach, Ethereum&#x27;s DNS-based discovery introduces efficient authentication leveraging <!-- --><a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle trees<!-- --></a>.<!-- --></p>
<!-- --><p>A further advantage over static node lists is the separation of code/release management and bootstrap node management.
However, changing and updating the list of bootstrap nodes still requires administrative privileges because DNS records have to be added or updated.<!-- --></p>
<!-- --><p>While this method of discovery still requires centralized elements,
node list management can be delegated to various DNS zones managed by other entities mitigating centralization.<!-- --></p>
<!-- --><h2><a class="anchor" id="discovery-v5"></a><a class="ha" href="#discovery-v5">Discovery V5<!-- --></a></h2>
<!-- --><p>A much more dynamic method of ambient peer discovery is <!-- --><a href="https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5.md">Discovery v5<!-- --></a>, which is Ethereum&#x27;s peer discovery protocol.
It is based on the <!-- --><a href="https://en.wikipedia.org/wiki/Kademlia">Kademlia<!-- --></a> distributed hashtable (DHT).
An <!-- --><a href="https://vac.dev/kademlia-to-discv5">introduction to discv5 and its history<!-- --></a>, and a <!-- --><a href="https://vac.dev/feasibility-discv5">discv5 Waku v2 feasibility study<!-- --></a>
can be found in previous posts on this research log.<!-- --></p>
<!-- --><p>We use Discovery v5 as an ambient peer discovery method for Waku v2 because it is decentralized, efficient, actively researched, and has web3 as its main application area.
Discv5 also offers mitigation techniques for various attacks, which we cover later in this post.<!-- --></p>
<!-- --><p>Using a DHT (structured P2P network) as a means for ambient peer discovery, while using the gossipsub mesh network (unstructured P2P network) for transmitting actual messages,
Waku v2 leverages advantages from both worlds.
One of the main benefits of DHTs is offering a global view over participating nodes.
This, in turn, allows sampling random sets of nodes which is important for equally distributing load.
Gossipsub, on the other hand, offers great robustness and resilience against attacks.
Even if discv5 discovery should not work in advent of a DoS attack, Waku v2 can still operate switching to different discovery methods.<!-- --></p>
<!-- --><p>Discovery methods that use separate P2P networks still depend on bootstrapping,
which Waku v2 does via parameters on start-up or via DNS-based discovery.
This might raise the question of why such discovery methods are beneficial.
The answer lies in the aforementioned global view of DHTs. Without discv5 and similar methods, the bootstrap nodes are used as part of the gossipsub mesh.
This might put heavy load on these nodes and further, might open pathways to inference attacks.
Discv5, on the other hand, uses the bootstrap nodes merely as an entry to the discovery network and can provide random sets of nodes (sampled from a global view)
for bootstrapping or expanding the mesh.<!-- --></p>
<!-- --><h3><a class="anchor" id="dht-background"></a><a class="ha" href="#dht-background">DHT Background<!-- --></a></h3>
<!-- --><p>Distributed Hash Tables are a class of structured P2P overlay networks.
A DHT can be seen as a distributed node set of which each node is responsible for a part of the hash space.
In contrast to unstructured P2P networks, e.g. the mesh network maintained by gossipsub,
DHTs have a global view over the node set and the hash space (assuming the participating nodes behave well).<!-- --></p>
<!-- --><p>DHTs are susceptible to various kinds of attacks, especially <!-- --><a href="https://en.wikipedia.org/wiki/Sybil_attack">Sybil attacks<!-- --></a>
and <!-- --><a href="https://www.usenix.org/conference/usenixsecurity15/technical-sessions/presentation/heilman">eclipse attacks<!-- --></a>.
While security aspects have been addressed in various research papers, general practical solutions are not available.
However, discv5 introduced various practical mitigation techniques.<!-- --></p>
<!-- --><h3><a class="anchor" id="random-walk-discovery"></a><a class="ha" href="#random-walk-discovery">Random Walk Discovery<!-- --></a></h3>
<!-- --><p>While discv5 is based on the Kademlia DHT, it only uses the <!-- --><em>distributed node set<!-- --></em> aspect of DHTs.
It does not map values (items) into the distributed hash space.
This makes sense, because the main purpose of discv5 is discovering other nodes that support discv5, which are expected to be Ethereum nodes.
Ethereum nodes that want to discover other Ethereum nodes simply query the discv5 network for a random set of peers.
If Waku v2 would do the same, only a small subset of the retrieved nodes would support Waku v2.<!-- --></p>
<!-- --><p>A first naive solution for Waku v2 discv5 discovery is<!-- --></p>
<!-- --><ul>
<!-- --><li>retrieve a random node set, which is achieved by querying for a set of randomly chosen node IDs<!-- --></li>
<!-- --><li>filter the returned nodes on the query path based on Waku v2 capability via the <!-- --><a href="https://rfc.vac.dev/spec/31/">Waku v2 ENR<!-- --></a></li>
<!-- --><li>repeat until enough Waku v2 capable nodes are found<!-- --></li>
<!-- --></ul>
<!-- --><p>This query process boils down to random walk discovery, which is very resilient against attacks, but also very inefficient if the number of nodes supporting the desired capability is small.
We refer to this as the needle-in-the-haystack problem.<!-- --></p>
<!-- --><h3><a class="anchor" id="random-walk-performance-estimation"></a><a class="ha" href="#random-walk-performance-estimation">Random Walk Performance Estimation<!-- --></a></h3>
<!-- --><p>This subsection provides a rough estimation of the overhead introduced by random walk discovery.<!-- --></p>
<!-- --><p>Given the following parameters:<!-- --></p>
<!-- --><ul>
<!-- --><li><span><span style="display:inline">$n$</span></span> number of total nodes participating in discv5<!-- --></li>
<!-- --><li><span><span style="display:inline">$p$</span></span> percentage of nodes supporting Waku<!-- --></li>
<!-- --><li><span><span style="display:inline">$W$</span></span> the event of having at least one Waku node in a random sample<!-- --></li>
<!-- --><li><span><span style="display:inline">$k$</span></span> the size of a random sample (default = 16)<!-- --></li>
<!-- --><li><span><span style="display:inline">$\alpha$</span></span> the number of parallel queries started<!-- --></li>
<!-- --><li><span><span style="display:inline">$b$</span></span> bits per hop<!-- --></li>
<!-- --><li><span><span style="display:inline">$q$</span></span> the number of queries<!-- --></li>
<!-- --></ul>
<!-- --><p>A query takes <!-- --><span><span style="display:inline">$log_{2^b}n$</span></span> hops to retrieve a random sample of nodes.<!-- --></p>
<!-- --><p><span><span style="display:inline">$P(W) = 1 - (1-p/100)^k$</span></span> is the probability of having at least one Waku node in the sample.<!-- --></p>
<!-- --><p><span><span style="display:inline">$P(W^q) = 1 - (1-p/100)^{kq}$</span></span>  is the probability of having at least one Waku node in the union of <!-- --><span><span style="display:inline">$q$</span></span> samples.<!-- --></p>
<!-- --><p>Expressing this in terms of <!-- --><span><span style="display:inline">$q$</span></span>, we can write:
<!-- --><span><span style="display:inline">$P(W^q) = 1 - (1-p/100)^{kq} \iff  q = log_{(1-p/100)^k}(1-P(W^q))$</span></span></p>
<!-- --><p>Figure 1 shows a log-log plot for <!-- --><span><span style="display:inline">$P(W^q) = 90\%$</span></span>.<!-- --></p>
<!-- --><figure class="rehype-figure"><img src="/compiled-assets/img/waku_v2_discv5_random_walk_estimation.svg%22" alt="Figure 1: log-log plot showing the number of queries necessary to retrieve a Waku v2 node with a probability of 90% in relation to the Waku v2 node concentration in the network."/><figcaption>Figure 1: log-log plot showing the number of queries necessary to retrieve a Waku v2 node with a probability of 90% in relation to the Waku v2 node concentration in the network.<!-- --></figcaption></figure>
<!-- --><p>Assuming <!-- --><span><span style="display:inline">$p=0.1$</span></span>, we would need<!-- --></p>
<!-- --><p><span><span style="display:inline">$0.9 = 1 - (1-0.1/100)^{16q} =&gt; q \approx 144$</span></span></p>
<!-- --><p>queries to get a Waku node with 90% probability, which leads to <!-- --><span><span style="display:inline">$\approx 144 * 18 = 2592$</span></span> overlay hops.
Choosing <!-- --><span><span style="display:inline">$b=3$</span></span> would reduce the number to <!-- --><span><span style="display:inline">$\approx 144 * 6 = 864$</span></span>.
Even when choosing <!-- --><span><span style="display:inline">$\alpha = 10$</span></span> we would have to wait at least 80 RTTs.
This effort is just for retrieving a single Waku node. Ideally, we want at least 3 Waku nodes for bootstrapping a Waku relay.<!-- --></p>
<!-- --><p><a href="https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5-theory.md#ad-placement-and-topic-radius">The discv5 doc<!-- --></a> roughly estimates <!-- --><span><span style="display:inline">$p=1%$</span></span> to be the threshold for acceptably efficient random walk discovery.
This is in line with our estimation:<!-- --></p>
<!-- --><p><span><span style="display:inline">$0.9 = 1 - (1-1/100)^{16q} =&gt; q \approx 14$</span></span></p>
<!-- --><p>The number of necessary queries is linearly dependent on the percentage <!-- --><span><span style="display:inline">$p$</span></span> of Waku nodes.
The number of hops per query is logarithmically dependent on <!-- --><span><span style="display:inline">$n$</span></span>.
Thus, random walk searching is inefficient for small percentages <!-- --><span><span style="display:inline">$p$</span></span>.
Still, random walks are more resilient against attacks.<!-- --></p>
<!-- --><p>We can conclude that a Waku node concentration below 1% renders vanilla discv5 unfit for our needs.
Our current solution and future plans for solving this issue are covered in the next subsections.<!-- --></p>
<!-- --><h3><a class="anchor" id="simple-solution-separate-discovery-network"></a><a class="ha" href="#simple-solution-separate-discovery-network">Simple Solution: Separate Discovery Network<!-- --></a></h3>
<!-- --><p>The simple solution we currently use for <!-- --><a href="https://rfc.vac.dev/spec/33/">Waku v2 discv5<!-- --></a> is a separate discv5 network.
All (well behaving) nodes in this network support Waku v2, resulting in a very high query efficiency.
However, this solution reduces resilience because the difficulty of attacking a DHT scales with the number of participating nodes.<!-- --></p>
<!-- --><h3><a class="anchor" id="discv5-topic-discovery"></a><a class="ha" href="#discv5-topic-discovery">Discv5 Topic Discovery<!-- --></a></h3>
<!-- --><p>We did not base our solution on the <!-- --><a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory.md#topic-advertisement">current version of discv5 topic discovery<!-- --></a>,
because, similar to random walk discovery, it suffers from poor performance for relatively rare capabilities/topics.<!-- --></p>
<!-- --><p>However, there is <!-- --><a href="https://github.com/harnen/service-discovery-paper">ongoing research<!-- --></a> in discv5 topic discovery which is close to ideas we explored when pondering efficient and resilient Waku discv5 solutions.
We keep a close eye on this research, give feedback, and make suggestions, as we plan to switch to this version of topic discovery in the future.<!-- --></p>
<!-- --><p>In a nutshell, topic discovery will manage separate routing tables for each topic.
These topic specific tables are initialized with nodes from the discv5 routing table.
While the buckets of the discv5 routing table represent distance intervals from the node&#x27;s <!-- --><code>node ID</code>, the topic table buckets represent distance intervals from <!-- --><code>topic ID</code>s.<!-- --></p>
<!-- --><p>Nodes that want to register a topic try to register that topic at one random peer per bucket.
This leads to registering the topic at peers in closer and closer neighbourhoods around the topic ID, which
yields a very efficient and resilient compromise between random walk discovery and DHT discovery.
Peers in larger neighbourhoods around the topic ID are less efficient to discover, however more resilient against eclipse attacks and vice versa.<!-- --></p>
<!-- --><p>Further, this works well with the overload and DoS protection discv5 employs.
Discv5 limits the amount of nodes registered per topic on a single peer. Further, discv5 enforces a waiting time before nodes can register topics at peers.
So, for popular topics, a node might fail to register the topic in a close neighbourhood.
However, because the topic is popular (has a high occurrence percentage <!-- --><span><span style="display:inline">$p$</span></span>), it can still be efficiently discovered.<!-- --></p>
<!-- --><p>In the future, we also plan to integrate Waku v2 capability discovery, which will not only allow asking for nodes that support Waku v2,
but asking for Waku v2 nodes supporting specific Waku v2 protocols like filter or store.
For the store protocol we envision sub-capabilities reflecting message topics and time frames of messages.
We will also investigate related security implications.<!-- --></p>
<!-- --><h3><a class="anchor" id="attacks-on-dhts"></a><a class="ha" href="#attacks-on-dhts">Attacks on DHTs<!-- --></a></h3>
<!-- --><p>In this post, we only briefly describe common attacks on DHTs.
These attacks are mainly used for denial of service (DoS),
but can also used as parts of more sophisticated attacks, e.g. deanonymization attacks.
A future post on this research log will cover security aspects of ambient peer discovery with a focus on privacy and anonymity.<!-- --></p>
<!-- --><p><em>Sybil Attack<!-- --></em></p>
<!-- --><p>The power of an attacker in a DHT is proportional to the number of controlled nodes.
Controlling nodes comes at a high resource cost and/or requires controlling a botnet via a preliminary attack.<!-- --></p>
<!-- --><p>In a Sybil attack, an attacker generates lots of virtual node identities.
This allows the attacker to control a large portion of the ID space in a DHT at a relatively low cost.
Sybil attacks are especially powerful when the attacker can freely choose the IDs of generated nodes,
because this allows positioning at chosen points in the DHT.<!-- --></p>
<!-- --><p>Because Sybil attacks amplify the power of many attacks against DHTs,
making Sybil attacks as difficult as possible is the basis for resilient DHT operation.
The typical abstract mitigation approach is binding node identities to physical network interfaces.
To some extend, this can be achieved by introducing IP address based limits.
Further, generating node IDs can be bound by proof of work (PoW),
which, however, comes with a set of shortcomings, e.g. relatively high costs on resource restricted devices.
<!-- --><a href="https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5-rationale.md#sybil-and-eclipse-attacks">The discv5 doc<!-- --></a>
describes both Sybil and eclipse attacks, as well as concrete mitigation techniques employed by discv5.<!-- --></p>
<!-- --><p><em>Eclipse Attack<!-- --></em></p>
<!-- --><p>In an eclipse attack, nodes controlled by the attacker poison the routing tables of other nodes in a way that parts of the DHT become eclipsed, i.e. invisible.
When a controlled node is asked for the next step in a path,
it provides another controlled node as the next step,
effectively navigating the querying node around or away from certain areas of the DHT.
While several mitigation techniques have been researched, there is no definitive protection against eclipse attacks available as of yet.
One mitigation technique is increasing <!-- --><span><span style="display:inline">$\alpha$</span></span>, the number of parallel queries, and following each concurrent path independently for the lookup.<!-- --></p>
<!-- --><p>The eclipse attack becomes very powerful in combination with a successful Sybil attack;
especially when the attacker can freely choose the position of the Sybil nodes.<!-- --></p>
<!-- --><p>The aforementioned new topic discovery of discv5 provides a good balance between protection against eclipse attacks and query performance.<!-- --></p>
<!-- --><h2><a class="anchor" id="peer-exchange-protocol"></a><a class="ha" href="#peer-exchange-protocol">Peer Exchange Protocol<!-- --></a></h2>
<!-- --><p>While discv5 based ambient peer discovery has many desirable properties, resource restricted nodes and nodes behind restrictive NAT setups cannot run discv5 satisfactory.
With these nodes in mind, we started working on a simple <!-- --><em>peer exchange protocol<!-- --></em> based on ideas proposed <!-- --><a href="https://github.com/libp2p/specs/issues/222">here<!-- --></a>.
The peer exchange protocol will allow nodes to ask peers for additional peers.
Similar to discv5, the peer exchange protocol will also support capability discovery.<!-- --></p>
<!-- --><p>The new peer exchange protocol can be seen as a simple replacement for the <!-- --><a href="https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/rendezvous/README.md">Rendezvous protocol<!-- --></a>, which Waku v2 does not support.
While the rendezvous protocol involves nodes registering at rendezvous peers, the peer exchange protocol simply allows nodes to ask any peer for a list of peers (with a certain set of capabilities).
Rendezvous tends to introduce centralized elements as rendezvous peers have a super-peer role.<!-- --></p>
<!-- --><p>In the future, we will investigate resource usage of <!-- --><a href="https://rfc.vac.dev/spec/33/">Waku v2 discv5<!-- --></a> and provide suggestions for minimal resources nodes should have to run discv5 satisfactory.<!-- --></p>
<!-- --><h2><a class="anchor" id="further-protocols-related-to-discovery"></a><a class="ha" href="#further-protocols-related-to-discovery">Further Protocols Related to Discovery<!-- --></a></h2>
<!-- --><p>Waku v2 comprises further protocols related to ambient peer discovery. We shortly mention them for context, even though they are not strictly ambient peer discovery protocols.<!-- --></p>
<!-- --><h3><a class="anchor" id="gossipsub-peer-exchange-protocol"></a><a class="ha" href="#gossipsub-peer-exchange-protocol">Gossipsub Peer Exchange Protocol<!-- --></a></h3>
<!-- --><p>Gossipsub provides an integrated <!-- --><a href="https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange">peer exchange<!-- --></a> mechanism which is also supported by Waku v2.
Gossipsub peer exchange works in a <!-- --><em>push<!-- --></em> manner. Nodes send peer lists to peers they prune from the active mesh.
This pruning is part of the gossipsub peer management, blurring the boundaries of <!-- --><em>peer management<!-- --></em> and <!-- --><em>ambient peer discovery<!-- --></em>.<!-- --></p>
<!-- --><p>We will investigate anonymity implications of this protocol and might disable it in favour of more anonymity-preserving protocols.
Sending a list of peers discloses information about the sending node.
We consider restricting these peer lists to cached peers that are currently not used in the active gossipsub mesh.<!-- --></p>
<!-- --><h3><a class="anchor" id="capability-negotiation"></a><a class="ha" href="#capability-negotiation">Capability Negotiation<!-- --></a></h3>
<!-- --><p>Some of the ambient peer discovery methods used by Waku2 will support capability discovery.
This allows to narrow down the set of retrieved peers to peers that support specific capabilities.
This is efficient because it avoids establishing connections to nodes that we are not interested in.<!-- --></p>
<!-- --><p>However, the ambient discovery interface does not require capability discovery, which will lead to nodes having peers with unknown capabilities in their peer lists.
We work on a <!-- --><em>capability negotiation protocol<!-- --></em> which allows nodes to ask peers<!-- --></p>
<!-- --><ul>
<!-- --><li>for their complete list of capabilities, and<!-- --></li>
<!-- --><li>whether they support a specific capability<!-- --></li>
<!-- --></ul>
<!-- --><p>We will investigate security implications, especially when sending full capability lists.<!-- --></p>
<!-- --><h2><a class="anchor" id="nat-traversal"></a><a class="ha" href="#nat-traversal">NAT traversal<!-- --></a></h2>
<!-- --><p>For <!-- --><a href="https://docs.libp2p.io/concepts/nat/">NAT traversal<!-- --></a>, Waku v2 currently supports the port mapping protocols <!-- --><a href="https://en.wikipedia.org/wiki/Universal_Plug_and_Play">UPnP<!-- --></a> and <!-- --><a href="https://datatracker.ietf.org/doc/html/rfc6886">NAT-PMP<!-- --></a> / <!-- --><a href="https://datatracker.ietf.org/doc/html/rfc6887">PCP<!-- --></a>.<!-- --></p>
<!-- --><p>In the future, we plan to add support for parts of <!-- --><a href="https://datatracker.ietf.org/doc/html/rfc8445">ICE<!-- --></a>, e.g. <!-- --><a href="https://datatracker.ietf.org/doc/html/rfc7350">STUN<!-- --></a>.
We do not plan to support <!-- --><a href="https://www.rfc-editor.org/rfc/rfc5928">TURN<!-- --></a> because TURN relays would introduce a centralized element.
A modified decentralized version of TURN featuring incentivization might be an option in the future;
strong peers could offer a relay service similar to TURN.<!-- --></p>
<!-- --><p>There are <!-- --><a href="https://github.com/ethereum/devp2p/issues/199">plans to integrate more NAT traversal into discv5<!-- --></a>, in which we might participate.
So far, the only traversal technique supported by discv5 is nodes receiving their external IP address in pong messages.<!-- --></p>
<!-- --><p>While NAT traversal is very important, adding more NAT traversal techniques is not a priority at the moment.
Nodes behind restrictive symmetric NAT setups cannot be discovered, but they can still discover peers in less restrictive setups.
While we wish to have as many nodes as possible to be discoverable via ambient peer discovery, two nodes behind a restrictive symmetric NAT can still exchange Waku v2 messages if they discovered a shared peer.
This is one of the nice resilience related properties of flooding based routing algorithms.<!-- --></p>
<!-- --><p>For mobile nodes, which suffer from changing IP addresses and double NAT setups, we plan using the peer exchange protocol to ask peers for more peers.
Besides saving resources on resource restricted devices, this approach works as long as peers are in less restrictive environments.<!-- --></p>
<!-- --><h2><a class="anchor" id="conclusion-and-future-prospects"></a><a class="ha" href="#conclusion-and-future-prospects">Conclusion and Future Prospects<!-- --></a></h2>
<!-- --><p><em>Ambient peer discovery<!-- --></em> is an integral part of decentralized applications. It allows nodes to learn about peers in the network.
As of yet, Waku v2 supports DNS-based discovery and a slightly modified version of discv5.
We are working on further protocols, including a peer exchange protocol that allows resource restricted nodes to ask stronger peers for peer lists.
Further, we are working on adding capability discovery to our ambient discovery protocols, allowing nodes to find peers with desired properties.<!-- --></p>
<!-- --><p>These protocols can be combined in a modular way and allow Waku v2 nodes to build a strong and resilient mesh network,
even if some discovery methods are not available in a given situation.<!-- --></p>
<!-- --><p>We will investigate security properties of these discovery mechanisms with a focus on privacy and anonymity in a future post on this research log.
As an outlook we can already state that DHT approaches typically allow inferring information about the querying node.
Further, sending peer lists allows inferring the position of a node within the mesh, and by extension information about the node.
Waku v2 already provides some mitigation, because the mesh for transmitting actual messages, and the peer discovery network are separate.
To mitigate information leakage by transmitting peer lists, we plan to only reply with lists of peers that nodes do not use in their active meshes.<!-- --></p>
<!-- --><hr/>
<!-- --><h2><a class="anchor" id="references"></a><a class="ha" href="#references">References<!-- --></a></h2>
<!-- --><ul>
<!-- --><li><a href="https://rfc.vac.dev/spec/10/">Waku v2<!-- --></a></li>
<!-- --><li><a href="https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/README.md">libp2p gossipsub<!-- --></a></li>
<!-- --><li><a href="https://en.wikipedia.org/wiki/Peer-to-peer#Unstructured_networks">unstructured P2P network<!-- --></a></li>
<!-- --><li><a href="https://docs.libp2p.io/concepts/publish-subscribe/#discovery">ambient peer discovery<!-- --></a></li>
<!-- --><li><a href="https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5.md">Discovery v5<!-- --></a></li>
<!-- --><li><a href="https://en.wikipedia.org/wiki/Kademlia">Kademlia<!-- --></a></li>
<!-- --><li><a href="https://vac.dev/kademlia-to-discv5">Discv5 history<!-- --></a></li>
<!-- --><li><a href="https://vac.dev/feasibility-discv5">Discv5 Waku v2 feasibility study<!-- --></a></li>
<!-- --><li><a href="https://vac.dev/dns-based-discovery">DNS-based discovery<!-- --></a></li>
<!-- --><li><a href="https://eips.ethereum.org/EIPS/eip-1459">EIP-1459<!-- --></a></li>
<!-- --><li><a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle trees<!-- --></a></li>
<!-- --><li><a href="https://en.wikipedia.org/wiki/Sybil_attack">Sybil attack<!-- --></a></li>
<!-- --><li><a href="https://www.usenix.org/conference/usenixsecurity15/technical-sessions/presentation/heilman">eclipse attack<!-- --></a></li>
<!-- --><li><a href="https://rfc.vac.dev/spec/31/">Waku v2 ENR<!-- --></a></li>
<!-- --><li><a href="https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5-theory.md#ad-placement-and-topic-radius">Discv5 topic discovery<!-- --></a></li>
<!-- --><li><a href="https://github.com/harnen/service-discovery-paper">Discv5 paper<!-- --></a></li>
<!-- --><li><a href="https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5-rationale.md#sybil-and-eclipse-attacks">Discv5 vs Sybil and eclipse attacks<!-- --></a></li>
<!-- --><li><a href="https://github.com/libp2p/specs/issues/222">peer exchange idea<!-- --></a></li>
<!-- --><li><a href="https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/rendezvous/README.md">Rendezvous protocol<!-- --></a></li>
<!-- --><li><a href="https://rfc.vac.dev/spec/33/">Waku v2 discv5<!-- --></a></li>
<!-- --><li><a href="https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange">Gossipsub peer exchange<!-- --></a></li>
<!-- --><li><a href="https://docs.libp2p.io/concepts/nat/">NAT traversal<!-- --></a></li>
<!-- --><li><a href="https://en.wikipedia.org/wiki/Universal_Plug_and_Play">UPnP<!-- --></a></li>
<!-- --><li><a href="https://datatracker.ietf.org/doc/html/rfc6886">NAT-PMP<!-- --></a></li>
<!-- --><li><a href="https://datatracker.ietf.org/doc/html/rfc6887">PCP<!-- --></a>.<!-- --></li>
<!-- --><li><a href="https://github.com/ethereum/devp2p/issues/199">Discv5 topic efficiency issue<!-- --></a></li>
<!-- --></ul></article><aside class="Styles_container__3DqFl Style_toc__v7JJe Styles_common_toc__nMHyQ hidden-scroll"><nav class="Styles_tocComponent__fhPld hidden-scroll"><ul><li class="h-2"><a class="" href="/wakuv2-apd#static-node-lists">Static Node Lists</a></li><li class="h-2"><a class="" href="/wakuv2-apd#dns-based-discovery">DNS-based Discovery</a></li><li class="h-2"><a class="" href="/wakuv2-apd#discovery-v5">Discovery V5</a></li><li class="h-3"><a class="" href="/wakuv2-apd#dht-background">DHT Background</a></li><li class="h-3"><a class="" href="/wakuv2-apd#random-walk-discovery">Random Walk Discovery</a></li><li class="h-3"><a class="" href="/wakuv2-apd#random-walk-performance-estimation">Random Walk Performance Estimation</a></li><li class="h-3"><a class="" href="/wakuv2-apd#simple-solution-separate-discovery-network">Simple Solution: Separate Discovery Network</a></li><li class="h-3"><a class="" href="/wakuv2-apd#discv5-topic-discovery">Discv5 Topic Discovery</a></li><li class="h-3"><a class="" href="/wakuv2-apd#attacks-on-dh-ts">Attacks on DHTs</a></li><li class="h-2"><a class="" href="/wakuv2-apd#peer-exchange-protocol">Peer Exchange Protocol</a></li><li class="h-2"><a class="" href="/wakuv2-apd#further-protocols-related-to-discovery">Further Protocols Related to Discovery</a></li><li class="h-3"><a class="" href="/wakuv2-apd#gossipsub-peer-exchange-protocol">Gossipsub Peer Exchange Protocol</a></li><li class="h-3"><a class="" href="/wakuv2-apd#capability-negotiation">Capability Negotiation</a></li><li class="h-2"><a class="" href="/wakuv2-apd#nat-traversal">NAT traversal</a></li><li class="h-2"><a class="" href="/wakuv2-apd#conclusion-and-future-prospects">Conclusion and Future Prospects</a></li><li class="h-2"><a class="" href="/wakuv2-apd#references">References</a></li></ul></nav></aside></main><footer class="Styles_container___YkOC undefined Styles_common_footer__1rPoh"><div class="footer-content-container Styles_content__0jn9p"><div><p><span class="copy-left">©</span><span>2023<!-- --></span><span> Vac Research</span><span> - </span><span>Vac - Communication, Privacy, Etc</span></p></div><div class="Styles_bottomPart__CsMh_"><div class="Styles_socialMedia__AmAKz "><span><a href="https://twitter.com/vacp2p" class="button"><svg xmlns="http://www.w3.org/2000/svg" width="30" viewBox="0 0 543.684 543.684" xml:space="preserve"><path d="M527.657 106.697a231.362 231.362 0 0 1-8.041 2.191c-16.384 4.137-17.89-1.322-6.028-13.366a109.306 109.306 0 0 0 14.082-17.607c9.137-14.217 1.212-20.417-14.333-13.776a224.853 224.853 0 0 1-16.897 6.432c-16.017 5.379-38.746-2.735-53.018-11.787-18.018-11.426-38.495-17.136-61.438-17.136-32.137 0-59.529 11.334-82.192 33.984-22.656 22.662-33.99 50.062-33.99 82.191 0 4.394.251 8.855.747 13.378.814 7.362-11.585 12.699-28.317 10.336-36.194-5.11-70.582-16.077-103.171-32.889-32.32-16.671-60.845-37.65-85.57-62.938-11.819-12.086-27.804-11.045-32.217 5.27-2.644 9.78-3.959 19.951-3.959 30.515 0 19.908 4.675 38.372 14.027 55.392 4.651 8.47 10.098 16.138 16.353 22.999 10.521 11.549 8.911 18.25-5.734 14.144-14.639-4.106-25.367-10.202-25.367-9.804v.722c0 28.048 8.807 52.693 26.432 73.911 10.857 13.072 23.47 23.17 37.834 30.282 15.147 7.503 22.203 11.688 13.733 12.784-5.11.661-10.251.991-15.422.991-3.5 0-7.172-.159-11.003-.483-6.059-.514-7.148 12.111 2.038 26.298 7.301 11.273 16.646 21.193 28.03 29.762 11.579 8.721 24.058 14.981 37.417 18.794 16.255 4.633 19.517 13.073 5.024 21.763-35.863 21.519-75.551 32.277-119.058 32.277-4.902 0-9.578-.11-14.045-.324-7.754-.373-2.552 6.456 12.417 14.296 46.775 24.499 97.43 36.738 151.972 36.738 41.237 0 79.964-6.529 116.176-19.596 36.199-13.066 67.136-30.576 92.791-52.516 25.655-21.94 47.779-47.173 66.365-75.711 18.581-28.537 32.424-58.33 41.543-89.376 9.106-31.053 13.666-62.167 13.666-93.342 0-2.809-.024-5.331-.067-7.552-.086-4.174 10.955-15.472 23.28-27.032a242.397 242.397 0 0 0 15.937-16.444c11.179-12.688 6.228-18.502-9.997-13.771z"></path></svg></a></span><span><a href="https://discord.gg/PQFdubGt6d" class="button"><svg width="30" viewBox="0 0 71 55" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#discord_svg__a)"><path d="M60.105 4.898A58.55 58.55 0 0 0 45.653.415a.22.22 0 0 0-.233.11 40.784 40.784 0 0 0-1.8 3.697c-5.456-.817-10.886-.817-16.23 0-.485-1.164-1.201-2.587-1.828-3.697a.228.228 0 0 0-.233-.11 58.386 58.386 0 0 0-14.451 4.483.207.207 0 0 0-.095.082C1.578 18.73-.944 32.144.293 45.39a.244.244 0 0 0 .093.167c6.073 4.46 11.955 7.167 17.729 8.962a.23.23 0 0 0 .249-.082 42.08 42.08 0 0 0 3.627-5.9.225.225 0 0 0-.123-.312 38.772 38.772 0 0 1-5.539-2.64.228.228 0 0 1-.022-.378c.372-.279.744-.569 1.1-.862a.22.22 0 0 1 .23-.03c11.619 5.304 24.198 5.304 35.68 0a.219.219 0 0 1 .233.027c.356.293.728.586 1.103.865a.228.228 0 0 1-.02.378 36.384 36.384 0 0 1-5.54 2.637.227.227 0 0 0-.121.315 47.249 47.249 0 0 0 3.624 5.897.225.225 0 0 0 .249.084c5.801-1.794 11.684-4.502 17.757-8.961a.228.228 0 0 0 .092-.164c1.48-15.315-2.48-28.618-10.497-40.412a.18.18 0 0 0-.093-.084Zm-36.38 32.427c-3.497 0-6.38-3.211-6.38-7.156 0-3.944 2.827-7.156 6.38-7.156 3.583 0 6.438 3.24 6.382 7.156 0 3.945-2.827 7.156-6.381 7.156Zm23.593 0c-3.498 0-6.38-3.211-6.38-7.156 0-3.944 2.826-7.156 6.38-7.156 3.582 0 6.437 3.24 6.38 7.156 0 3.945-2.798 7.156-6.38 7.156Z" fill="#23272A"></path></g><defs><clipPath id="discord_svg__a"><path fill="#fff" d="M0 0h71v55H0z"></path></clipPath></defs></svg></a></span><span><a href="https://github.com/vacp2p" class="button"><svg width="30" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M512 0C229.12 0 0 229.12 0 512c0 226.56 146.56 417.92 350.08 485.76 25.6 4.48 35.2-10.88 35.2-24.32 0-12.16-.64-52.48-.64-95.36-128.64 23.68-161.92-31.36-172.16-60.16-5.76-14.72-30.72-60.16-52.48-72.32-17.92-9.6-43.52-33.28-.64-33.92 40.32-.64 69.12 37.12 78.72 52.48 46.08 77.44 119.68 55.68 149.12 42.24 4.48-33.28 17.92-55.68 32.64-68.48-113.92-12.8-232.96-56.96-232.96-252.8 0-55.68 19.84-101.76 52.48-137.6-5.12-12.8-23.04-65.28 5.12-135.68 0 0 42.88-13.44 140.8 52.48 40.96-11.52 84.48-17.28 128-17.28 43.52 0 87.04 5.76 128 17.28 97.92-66.56 140.8-52.48 140.8-52.48 28.16 70.4 10.24 122.88 5.12 135.68 32.64 35.84 52.48 81.28 52.48 137.6 0 196.48-119.68 240-233.6 252.8 18.56 16 34.56 46.72 34.56 94.72 0 68.48-.64 123.52-.64 140.8 0 13.44 9.6 29.44 35.2 24.32C877.44 929.92 1024 737.92 1024 512 1024 229.12 794.88 0 512 0Z" fill="#1B1F23"></path></svg></a></span></div><nav class="Styles_legal__0ciDG"><a title="Privacy Policy" href="/privacy-policy">Privacy Policy</a></nav></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"markdown":{"content":"\n[Waku v2](https://rfc.vac.dev/spec/10/) comprises a set of modular protocols for secure, privacy preserving communication.\nAvoiding centralization, these protocols exchange messages over a P2P network layer.\nIn order to build a P2P network, participating nodes first have to discover peers within this network.\nThis is where [*ambient peer discovery*](https://docs.libp2p.io/concepts/publish-subscribe/#discovery) comes into play:\nit allows nodes to find peers, making it an integral part of any decentralized application.\n\nIn this post the term *node* to refers to *our* endpoint or the endpoint that takes action,\nwhile the term *peer* refers to other endpoints in the P2P network.\nThese endpoints can be any device connected to the Internet: e.g. servers, PCs, notebooks, mobile devices, or applications like a browser.\nAs such, nodes and peers are the same. We use these terms for the ease of explanation without loss of generality.\n\n\nIn Waku's modular design, ambient peer discovery is an umbrella term for mechanisms that allow nodes to find peers.\nVarious ambient peer discovery mechanisms are supported, and each is specified as a separate protocol.\nWhere do these protocols fit into Waku's protocol stack?\nThe P2P layer of Waku v2 builds on [libp2p gossipsub](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/README.md).\nNodes participating in a gossipsub protocol manage a mesh network that is used for routing messages.\nThis mesh network is an [unstructured P2P network](https://en.wikipedia.org/wiki/Peer-to-peer#Unstructured_networks)\noffering high robustness and resilience against attacks.\nGossipsub implements many improvements overcoming the shortcomings typically associated with unstructured P2P networks, e.g. inefficient flooding based routing.\nThe gossipsub mesh network is managed in a decentralized way, which requires each node to know other participating peers.\nWaku v2 may use any combination of its ambient discovery protocols to find appropriate peers.\n\nSummarizing, Waku v2 comprises a *peer management layer* based on libp2p gossipsub,\nwhich manages the peers of nodes, and an *ambient peer discovery layer*,\nwhich provides information about peers to the peer management layer.\n\nWe focus on ambient peer discovery methods that are in line with our goal of building a fully decentralized, generalized, privacy-preserving and censorship-resistant messaging protocol.\nSome of these protocols still need adjustments to adhere to our privacy and anonymity requirements. For now, we focus on operational stability and feasibility.\nHowever, when choosing techniques, we pay attention to selecting mechanisms that can feasibly be tweaked for privacy in future research efforts.\nBecause of the modular design and the fact that Waku v2 has several discovery methods at its disposal, we could even remove a protocol in case future evaluation deems it not fitting our standards.\n\nThis post covers the current state and future considerations of ambient peer discovery for Waku v2,\nand gives reason for changes and modifications we made or plan to make.\nThe ambient peer discovery protocols currently supported by Waku v2 are a modified version of Ethereum's [Discovery v5](https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5.md)\nand [DNS-based discovery](https://vac.dev/dns-based-discovery).\nWaku v2 further supports [gossipsub's peer exchange protocol](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange).\nIn addition, we plan to introduce protocols for general peer exchange and capability discovery, respectively.\nThe former allows resource restricted nodes to outsource querying for peers to stronger peers,\nthe latter allows querying peers for their supported capabilities.\nBesides these new protocols, we are working on integrating capability discovery in our existing ambient peer discovery protocols.\n\n## Static Node Lists\n\nThe simplest method of learning about peers in a P2P network is via static node lists.\nThese can be given to nodes as start-up parameters or listed in a config-file.\nThey can also be provided in a script-parseable format, e.g. in JSON.\nWhile this method of providing bootstrap nodes is very easy to implement, it requires static peers, which introduce centralized elements.\nAlso, updating static peer information introduces significant administrative overhead:\ncode and/or config files have to be updated and released.\nTypically, static node lists only hold a small number of bootstrap nodes, which may lead to high load on these nodes.\n\n\n## DNS-based Discovery\n\nCompared to static node lists,\n[DNS-based discovery](https://vac.dev/dns-based-discovery) (specified in [EIP-1459](https://eips.ethereum.org/EIPS/eip-1459))\nprovides a more dynamic way of discovering bootstrap nodes.\nIt is very efficient, can easily be handled by resource restricted devices and provides very good availability.\nIn addition to a naive DNS approach, Ethereum's DNS-based discovery introduces efficient authentication leveraging [Merkle trees](https://en.wikipedia.org/wiki/Merkle_tree).\n\nA further advantage over static node lists is the separation of code/release management and bootstrap node management.\nHowever, changing and updating the list of bootstrap nodes still requires administrative privileges because DNS records have to be added or updated.\n\nWhile this method of discovery still requires centralized elements,\nnode list management can be delegated to various DNS zones managed by other entities mitigating centralization.\n\n\n## Discovery V5\n\nA much more dynamic method of ambient peer discovery is [Discovery v5](https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5.md), which is Ethereum's peer discovery protocol.\nIt is based on the [Kademlia](https://en.wikipedia.org/wiki/Kademlia) distributed hashtable (DHT).\nAn [introduction to discv5 and its history](https://vac.dev/kademlia-to-discv5), and a [discv5 Waku v2 feasibility study](https://vac.dev/feasibility-discv5)\ncan be found in previous posts on this research log.\n\nWe use Discovery v5 as an ambient peer discovery method for Waku v2 because it is decentralized, efficient, actively researched, and has web3 as its main application area.\nDiscv5 also offers mitigation techniques for various attacks, which we cover later in this post.\n\nUsing a DHT (structured P2P network) as a means for ambient peer discovery, while using the gossipsub mesh network (unstructured P2P network) for transmitting actual messages,\nWaku v2 leverages advantages from both worlds.\nOne of the main benefits of DHTs is offering a global view over participating nodes. \nThis, in turn, allows sampling random sets of nodes which is important for equally distributing load.\nGossipsub, on the other hand, offers great robustness and resilience against attacks.\nEven if discv5 discovery should not work in advent of a DoS attack, Waku v2 can still operate switching to different discovery methods.\n\nDiscovery methods that use separate P2P networks still depend on bootstrapping,\nwhich Waku v2 does via parameters on start-up or via DNS-based discovery.\nThis might raise the question of why such discovery methods are beneficial.\nThe answer lies in the aforementioned global view of DHTs. Without discv5 and similar methods, the bootstrap nodes are used as part of the gossipsub mesh.\nThis might put heavy load on these nodes and further, might open pathways to inference attacks.\nDiscv5, on the other hand, uses the bootstrap nodes merely as an entry to the discovery network and can provide random sets of nodes (sampled from a global view)\nfor bootstrapping or expanding the mesh.\n\n### DHT Background\n\nDistributed Hash Tables are a class of structured P2P overlay networks.\nA DHT can be seen as a distributed node set of which each node is responsible for a part of the hash space.\nIn contrast to unstructured P2P networks, e.g. the mesh network maintained by gossipsub,\nDHTs have a global view over the node set and the hash space (assuming the participating nodes behave well).\n\nDHTs are susceptible to various kinds of attacks, especially [Sybil attacks](https://en.wikipedia.org/wiki/Sybil_attack)\nand [eclipse attacks](https://www.usenix.org/conference/usenixsecurity15/technical-sessions/presentation/heilman).\nWhile security aspects have been addressed in various research papers, general practical solutions are not available.\nHowever, discv5 introduced various practical mitigation techniques.\n\n### Random Walk Discovery\n\nWhile discv5 is based on the Kademlia DHT, it only uses the *distributed node set* aspect of DHTs.\nIt does not map values (items) into the distributed hash space.\nThis makes sense, because the main purpose of discv5 is discovering other nodes that support discv5, which are expected to be Ethereum nodes.\nEthereum nodes that want to discover other Ethereum nodes simply query the discv5 network for a random set of peers.\nIf Waku v2 would do the same, only a small subset of the retrieved nodes would support Waku v2.\n\nA first naive solution for Waku v2 discv5 discovery is\n\n* retrieve a random node set, which is achieved by querying for a set of randomly chosen node IDs\n* filter the returned nodes on the query path based on Waku v2 capability via the [Waku v2 ENR](https://rfc.vac.dev/spec/31/)\n* repeat until enough Waku v2 capable nodes are found\n\nThis query process boils down to random walk discovery, which is very resilient against attacks, but also very inefficient if the number of nodes supporting the desired capability is small.\nWe refer to this as the needle-in-the-haystack problem.\n\n### Random Walk Performance Estimation\n\nThis subsection provides a rough estimation of the overhead introduced by random walk discovery.\n\nGiven the following parameters:\n\n* $n$ number of total nodes participating in discv5\n* $p$ percentage of nodes supporting Waku\n* $W$ the event of having at least one Waku node in a random sample\n* $k$ the size of a random sample (default = 16)\n* $\\alpha$ the number of parallel queries started\n* $b$ bits per hop\n* $q$ the number of queries\n\nA query takes $log_{2^b}n$ hops to retrieve a random sample of nodes.\n\n$P(W) = 1 - (1-p/100)^k$ is the probability of having at least one Waku node in the sample.\n\n$P(W^q) = 1 - (1-p/100)^{kq}$  is the probability of having at least one Waku node in the union of $q$ samples.\n\nExpressing this in terms of $q$, we can write:\n$$P(W^q) = 1 - (1-p/100)^{kq} \\iff  q = log_{(1-p/100)^k}(1-P(W^q))$$\n\nFigure 1 shows a log-log plot for $P(W^q) = 90\\%$.\n\n![Figure 1: log-log plot showing the number of queries necessary to retrieve a Waku v2 node with a probability of 90% in relation to the Waku v2 node concentration in the network.](/img/waku_v2_discv5_random_walk_estimation.svg\")\n\nAssuming $p=0.1$, we would need\n\n$$0.9 = 1 - (1-0.1/100)^{16q} =\u003e q \\approx 144$$\n\nqueries to get a Waku node with 90% probability, which leads to $\\approx 144 * 18 = 2592$ overlay hops.\nChoosing $b=3$ would reduce the number to $\\approx 144 * 6 = 864$.\nEven when choosing $\\alpha = 10$ we would have to wait at least 80 RTTs.\nThis effort is just for retrieving a single Waku node. Ideally, we want at least 3 Waku nodes for bootstrapping a Waku relay.\n\n[The discv5 doc](https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5-theory.md#ad-placement-and-topic-radius) roughly estimates $p=1%$ to be the threshold for acceptably efficient random walk discovery. \nThis is in line with our estimation:\n\n$$0.9 = 1 - (1-1/100)^{16q} =\u003e q \\approx 14$$\n\n\nThe number of necessary queries is linearly dependent on the percentage $p$ of Waku nodes.\nThe number of hops per query is logarithmically dependent on $n$.\nThus, random walk searching is inefficient for small percentages $p$.\nStill, random walks are more resilient against attacks.\n\nWe can conclude that a Waku node concentration below 1% renders vanilla discv5 unfit for our needs.\nOur current solution and future plans for solving this issue are covered in the next subsections.\n\n\n### Simple Solution: Separate Discovery Network\n\nThe simple solution we currently use for [Waku v2 discv5](https://rfc.vac.dev/spec/33/) is a separate discv5 network.\nAll (well behaving) nodes in this network support Waku v2, resulting in a very high query efficiency.\nHowever, this solution reduces resilience because the difficulty of attacking a DHT scales with the number of participating nodes.\n\n\n### Discv5 Topic Discovery\n\nWe did not base our solution on the [current version of discv5 topic discovery](https://github.com/ethereum/devp2p/blob/master/discv5/discv5-theory.md#topic-advertisement),\nbecause, similar to random walk discovery, it suffers from poor performance for relatively rare capabilities/topics.\n\nHowever, there is [ongoing research](https://github.com/harnen/service-discovery-paper) in discv5 topic discovery which is close to ideas we explored when pondering efficient and resilient Waku discv5 solutions.\nWe keep a close eye on this research, give feedback, and make suggestions, as we plan to switch to this version of topic discovery in the future.\n\nIn a nutshell, topic discovery will manage separate routing tables for each topic.\nThese topic specific tables are initialized with nodes from the discv5 routing table.\nWhile the buckets of the discv5 routing table represent distance intervals from the node's `node ID`, the topic table buckets represent distance intervals from `topic ID`s.\n\nNodes that want to register a topic try to register that topic at one random peer per bucket.\nThis leads to registering the topic at peers in closer and closer neighbourhoods around the topic ID, which\nyields a very efficient and resilient compromise between random walk discovery and DHT discovery.\nPeers in larger neighbourhoods around the topic ID are less efficient to discover, however more resilient against eclipse attacks and vice versa.\n\nFurther, this works well with the overload and DoS protection discv5 employs.\nDiscv5 limits the amount of nodes registered per topic on a single peer. Further, discv5 enforces a waiting time before nodes can register topics at peers.\nSo, for popular topics, a node might fail to register the topic in a close neighbourhood.\nHowever, because the topic is popular (has a high occurrence percentage $p$), it can still be efficiently discovered.\n\nIn the future, we also plan to integrate Waku v2 capability discovery, which will not only allow asking for nodes that support Waku v2,\nbut asking for Waku v2 nodes supporting specific Waku v2 protocols like filter or store.\nFor the store protocol we envision sub-capabilities reflecting message topics and time frames of messages.\nWe will also investigate related security implications.\n\n### Attacks on DHTs\n\nIn this post, we only briefly describe common attacks on DHTs.\nThese attacks are mainly used for denial of service (DoS),\nbut can also used as parts of more sophisticated attacks, e.g. deanonymization attacks.\nA future post on this research log will cover security aspects of ambient peer discovery with a focus on privacy and anonymity.\n\n*Sybil Attack*\n\nThe power of an attacker in a DHT is proportional to the number of controlled nodes.\nControlling nodes comes at a high resource cost and/or requires controlling a botnet via a preliminary attack.\n\nIn a Sybil attack, an attacker generates lots of virtual node identities.\nThis allows the attacker to control a large portion of the ID space in a DHT at a relatively low cost.\nSybil attacks are especially powerful when the attacker can freely choose the IDs of generated nodes,\nbecause this allows positioning at chosen points in the DHT.\n\nBecause Sybil attacks amplify the power of many attacks against DHTs,\nmaking Sybil attacks as difficult as possible is the basis for resilient DHT operation.\nThe typical abstract mitigation approach is binding node identities to physical network interfaces.\nTo some extend, this can be achieved by introducing IP address based limits.\nFurther, generating node IDs can be bound by proof of work (PoW),\nwhich, however, comes with a set of shortcomings, e.g. relatively high costs on resource restricted devices.\n[The discv5 doc](https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5-rationale.md#sybil-and-eclipse-attacks)\ndescribes both Sybil and eclipse attacks, as well as concrete mitigation techniques employed by discv5.\n\n\n*Eclipse Attack*\n\nIn an eclipse attack, nodes controlled by the attacker poison the routing tables of other nodes in a way that parts of the DHT become eclipsed, i.e. invisible.\nWhen a controlled node is asked for the next step in a path,\nit provides another controlled node as the next step,\neffectively navigating the querying node around or away from certain areas of the DHT.\nWhile several mitigation techniques have been researched, there is no definitive protection against eclipse attacks available as of yet.\nOne mitigation technique is increasing $\\alpha$, the number of parallel queries, and following each concurrent path independently for the lookup.\n\nThe eclipse attack becomes very powerful in combination with a successful Sybil attack;\nespecially when the attacker can freely choose the position of the Sybil nodes.\n\n\nThe aforementioned new topic discovery of discv5 provides a good balance between protection against eclipse attacks and query performance.\n\n## Peer Exchange Protocol\n\nWhile discv5 based ambient peer discovery has many desirable properties, resource restricted nodes and nodes behind restrictive NAT setups cannot run discv5 satisfactory.\nWith these nodes in mind, we started working on a simple *peer exchange protocol* based on ideas proposed [here](https://github.com/libp2p/specs/issues/222).\nThe peer exchange protocol will allow nodes to ask peers for additional peers.\nSimilar to discv5, the peer exchange protocol will also support capability discovery.\n\nThe new peer exchange protocol can be seen as a simple replacement for the [Rendezvous protocol](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/rendezvous/README.md), which Waku v2 does not support.\nWhile the rendezvous protocol involves nodes registering at rendezvous peers, the peer exchange protocol simply allows nodes to ask any peer for a list of peers (with a certain set of capabilities).\nRendezvous tends to introduce centralized elements as rendezvous peers have a super-peer role.\n\nIn the future, we will investigate resource usage of [Waku v2 discv5](https://rfc.vac.dev/spec/33/) and provide suggestions for minimal resources nodes should have to run discv5 satisfactory.\n\n\n## Further Protocols Related to Discovery\n\nWaku v2 comprises further protocols related to ambient peer discovery. We shortly mention them for context, even though they are not strictly ambient peer discovery protocols.\n\n\n### Gossipsub Peer Exchange Protocol\n\nGossipsub provides an integrated [peer exchange](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange) mechanism which is also supported by Waku v2.\nGossipsub peer exchange works in a *push* manner. Nodes send peer lists to peers they prune from the active mesh.\nThis pruning is part of the gossipsub peer management, blurring the boundaries of *peer management* and *ambient peer discovery*.\n\nWe will investigate anonymity implications of this protocol and might disable it in favour of more anonymity-preserving protocols.\nSending a list of peers discloses information about the sending node.\nWe consider restricting these peer lists to cached peers that are currently not used in the active gossipsub mesh.\n\n\n### Capability Negotiation\n\nSome of the ambient peer discovery methods used by Waku2 will support capability discovery.\nThis allows to narrow down the set of retrieved peers to peers that support specific capabilities.\nThis is efficient because it avoids establishing connections to nodes that we are not interested in.\n\nHowever, the ambient discovery interface does not require capability discovery, which will lead to nodes having peers with unknown capabilities in their peer lists.\nWe work on a *capability negotiation protocol* which allows nodes to ask peers\n\n* for their complete list of capabilities, and\n* whether they support a specific capability\n\nWe will investigate security implications, especially when sending full capability lists.\n\n## NAT traversal\n\nFor [NAT traversal](https://docs.libp2p.io/concepts/nat/), Waku v2 currently supports the port mapping protocols [UPnP](https://en.wikipedia.org/wiki/Universal_Plug_and_Play) and [NAT-PMP](https://datatracker.ietf.org/doc/html/rfc6886) / [PCP](https://datatracker.ietf.org/doc/html/rfc6887).\n\nIn the future, we plan to add support for parts of [ICE](https://datatracker.ietf.org/doc/html/rfc8445), e.g. [STUN](https://datatracker.ietf.org/doc/html/rfc7350).\nWe do not plan to support [TURN](https://www.rfc-editor.org/rfc/rfc5928) because TURN relays would introduce a centralized element.\nA modified decentralized version of TURN featuring incentivization might be an option in the future;\nstrong peers could offer a relay service similar to TURN.\n\nThere are [plans to integrate more NAT traversal into discv5](https://github.com/ethereum/devp2p/issues/199), in which we might participate.\nSo far, the only traversal technique supported by discv5 is nodes receiving their external IP address in pong messages.\n\nWhile NAT traversal is very important, adding more NAT traversal techniques is not a priority at the moment.\nNodes behind restrictive symmetric NAT setups cannot be discovered, but they can still discover peers in less restrictive setups.\nWhile we wish to have as many nodes as possible to be discoverable via ambient peer discovery, two nodes behind a restrictive symmetric NAT can still exchange Waku v2 messages if they discovered a shared peer.\nThis is one of the nice resilience related properties of flooding based routing algorithms.\n\nFor mobile nodes, which suffer from changing IP addresses and double NAT setups, we plan using the peer exchange protocol to ask peers for more peers.\nBesides saving resources on resource restricted devices, this approach works as long as peers are in less restrictive environments.\n\n\n## Conclusion and Future Prospects\n\n*Ambient peer discovery* is an integral part of decentralized applications. It allows nodes to learn about peers in the network.\nAs of yet, Waku v2 supports DNS-based discovery and a slightly modified version of discv5.\nWe are working on further protocols, including a peer exchange protocol that allows resource restricted nodes to ask stronger peers for peer lists.\nFurther, we are working on adding capability discovery to our ambient discovery protocols, allowing nodes to find peers with desired properties.\n\nThese protocols can be combined in a modular way and allow Waku v2 nodes to build a strong and resilient mesh network,\neven if some discovery methods are not available in a given situation.\n\nWe will investigate security properties of these discovery mechanisms with a focus on privacy and anonymity in a future post on this research log.\nAs an outlook we can already state that DHT approaches typically allow inferring information about the querying node.\nFurther, sending peer lists allows inferring the position of a node within the mesh, and by extension information about the node.\nWaku v2 already provides some mitigation, because the mesh for transmitting actual messages, and the peer discovery network are separate.\nTo mitigate information leakage by transmitting peer lists, we plan to only reply with lists of peers that nodes do not use in their active meshes.\n\n---\n\n## References\n\n- [Waku v2](https://rfc.vac.dev/spec/10/)\n- [libp2p gossipsub](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/README.md)\n- [unstructured P2P network](https://en.wikipedia.org/wiki/Peer-to-peer#Unstructured_networks)\n- [ambient peer discovery](https://docs.libp2p.io/concepts/publish-subscribe/#discovery)\n- [Discovery v5](https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5.md)\n- [Kademlia](https://en.wikipedia.org/wiki/Kademlia)\n- [Discv5 history](https://vac.dev/kademlia-to-discv5)\n- [Discv5 Waku v2 feasibility study](https://vac.dev/feasibility-discv5)\n- [DNS-based discovery](https://vac.dev/dns-based-discovery)\n- [EIP-1459](https://eips.ethereum.org/EIPS/eip-1459)\n- [Merkle trees](https://en.wikipedia.org/wiki/Merkle_tree)\n- [Sybil attack](https://en.wikipedia.org/wiki/Sybil_attack)\n- [eclipse attack](https://www.usenix.org/conference/usenixsecurity15/technical-sessions/presentation/heilman)\n- [Waku v2 ENR](https://rfc.vac.dev/spec/31/)\n- [Discv5 topic discovery](https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5-theory.md#ad-placement-and-topic-radius)\n- [Discv5 paper](https://github.com/harnen/service-discovery-paper)\n- [Discv5 vs Sybil and eclipse attacks](https://github.com/ethereum/devp2p/blob/6b0abc3d956a626c28dce1307ee9f546db17b6bd/discv5/discv5-rationale.md#sybil-and-eclipse-attacks)\n- [peer exchange idea](https://github.com/libp2p/specs/issues/222)\n- [Rendezvous protocol](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/rendezvous/README.md)\n- [Waku v2 discv5](https://rfc.vac.dev/spec/33/)\n- [Gossipsub peer exchange](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange)\n- [NAT traversal](https://docs.libp2p.io/concepts/nat/)\n- [UPnP](https://en.wikipedia.org/wiki/Universal_Plug_and_Play)\n- [NAT-PMP](https://datatracker.ietf.org/doc/html/rfc6886)\n- [PCP](https://datatracker.ietf.org/doc/html/rfc6887).\n- [Discv5 topic efficiency issue](https://github.com/ethereum/devp2p/issues/199)\n\n","metadata":{"layout":"post","name":"Waku v2 Ambient Peer Discovery","title":"Waku v2 Ambient Peer Discovery","date":"2022-05-09T10:00:00.000Z","author":"kaiserd","published":true,"permalink":"/wakuv2-apd","categories":"research","summary":"Introducing and discussing ambient peer discovery methods currently used by Waku v2, as well as future plans in this area.","image":"/img/waku_v2_discv5_random_walk_estimation.svg","discuss":"https://forum.vac.dev/t/discussion-waku-v2-ambient-peer-discovery/133","_includes":["math"]},"toc":[{"content":"Static Node Lists","slug":"static-node-lists","lvl":2,"i":0,"seen":0},{"content":"DNS-based Discovery","slug":"dns-based-discovery","lvl":2,"i":1,"seen":0},{"content":"Discovery V5","slug":"discovery-v5","lvl":2,"i":2,"seen":0},{"content":"DHT Background","slug":"dht-background","lvl":3,"i":3,"seen":0},{"content":"Random Walk Discovery","slug":"random-walk-discovery","lvl":3,"i":4,"seen":0},{"content":"Random Walk Performance Estimation","slug":"random-walk-performance-estimation","lvl":3,"i":5,"seen":0},{"content":"Simple Solution: Separate Discovery Network","slug":"simple-solution-separate-discovery-network","lvl":3,"i":6,"seen":0},{"content":"Discv5 Topic Discovery","slug":"discv5-topic-discovery","lvl":3,"i":7,"seen":0},{"content":"Attacks on DHTs","slug":"attacks-on-dh-ts","lvl":3,"i":8,"seen":0},{"content":"Peer Exchange Protocol","slug":"peer-exchange-protocol","lvl":2,"i":9,"seen":0},{"content":"Further Protocols Related to Discovery","slug":"further-protocols-related-to-discovery","lvl":2,"i":10,"seen":0},{"content":"Gossipsub Peer Exchange Protocol","slug":"gossipsub-peer-exchange-protocol","lvl":3,"i":11,"seen":0},{"content":"Capability Negotiation","slug":"capability-negotiation","lvl":3,"i":12,"seen":0},{"content":"NAT traversal","slug":"nat-traversal","lvl":2,"i":13,"seen":0},{"content":"Conclusion and Future Prospects","slug":"conclusion-and-future-prospects","lvl":2,"i":14,"seen":0},{"content":"References","slug":"references","lvl":2,"i":15,"seen":0}]},"navProps":{"metadata":{"published":true,"title":"Waku v2 Ambient Peer Discovery","layout":"post","name":"Waku v2 Ambient Peer Discovery","date":"2022-05-09T10:00:00.000Z","author":"kaiserd","permalink":"/wakuv2-apd","categories":"research","summary":"Introducing and discussing ambient peer discovery methods currently used by Waku v2, as well as future plans in this area.","image":"img/waku_v2_discv5_random_walk_estimation.svg","discuss":"https://forum.vac.dev/t/discussion-waku-v2-ambient-peer-discovery/133","_includes":["math"]},"navOrder":1652090400,"localPath":"research/2022-05-09-ambient-peer-discovery.md","path":["wakuv2-apd"],"children":[],"isDir":false},"routeParams":{"path":["wakuv2-apd"]}},"__N_SSG":true},"page":"/[[...path]]","query":{"path":["wakuv2-apd"]},"buildId":"_Gqh1sHcXYOQBFtsjeOtT","isFallback":false,"dynamicIds":[9440],"gsp":true,"scriptLoader":[]}</script></body></html>