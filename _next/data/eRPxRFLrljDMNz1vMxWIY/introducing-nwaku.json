{"pageProps":{"markdown":{"content":"\n## Background\n\nIf you've been following our [research log](https://vac.dev/research-log/),\nyou'll know that many things have happened in the world of Waku v2 since [our last general update](/waku-v2-ethereum-coscup).\nIn line with our [long term goals](https://vac.dev/#about),\nwe've introduced new protocols,\ntweaked our existing protocols\nand expanded our team.\nWe've also shown [in a series of practical experiments](/waku-v1-v2-bandwidth-comparison) that Waku v2 does indeed deliver on some of the [theoretical advantages](/waku-v2-plan) it was designed to have over its predecessor, Waku v1.\nA [sustainability and business workshop](https://forum.vac.dev/t/vac-sustainability-and-business-workshop/116) led to the formulation of a clearer vision for Vac as a team.\n\nFrom the beginning, our protocol development has been complemented by various client implementations of these protocols,\nfirst in [Nim](https://github.com/status-im/nim-waku),\nbut later also in [JavaScript](https://github.com/status-im/js-waku)\nand [Go](https://github.com/status-im/go-waku).\nA follow-up post will clarify the purposes, similarities and differences between these three clients.\nThe [Nim client](https://github.com/status-im/nim-waku/tree/d2fccb5220144893f994a67f2cc26661247f101f/waku/v2), is our reference implementation,\ndeveloped by the research team in parallel with the specs\nand building on a home-grown implementation of [`libp2p`](https://github.com/status-im/nim-libp2p).\nThe Nim client is suitable to run as [a standalone adaptive node](/waku-update),\nmanaged by individual operators\nor as an encapsulated service node in other applications.\nThis post looks at some recent developments within the Nim client.\n\n## 1. _**nim-waku**_ is now known as _**nwaku**_\n\nPronounced NWHA-koo.\nYou may already have seen us refer to \"`nwaku`\" on Vac communication channels,\nbut it is now official:\nThe `nim-waku` Waku v2 client has been named `nwaku`.\nWhy? Well, we needed a recognizable name for our client that could easily be referred to in everyday conversations\nand `nim-waku` just didn't roll off the tongue.\nWe've followed the example of the closely related [`nimbus` project](https://github.com/status-im/nimbus-eth2) to find a punchier name\nthat explicitly links the client to both the Waku set of protocols and the Nim language.\n\n## 2. Improvements in stability and performance\n\nThe initial implementation of Waku v2 demonstrated how the suite of protocols can be applied\nto form a generalized, peer-to-peer messaging network,\nwhile addressing a wide range of adaptive requirements.\nThis allowed us to lift several protocol [specifications](https://rfc.vac.dev/) from `raw` to `draft` status,\nindicating that a reference implementation exists for each.\nHowever, as internal dogfooding increased and more external applications started using `nwaku`,\nwe stepped up our focus on the client's stability and performance.\nThis is especially true where we want `nwaku` to run unsupervised in a production environment\nwithout any degradation in the services it provides.\n\nSome of the more significant productionization efforts over the last couple of months included:\n\n1. Reworking the `store` implementation to maintain stable memory usage\nwhile storing historical messages\nand serving multiple clients querying history simultaneously.\nPreviously, a `store` node would see gradual service degradation\ndue to inefficient memory usage when responding to history queries.\nQueries that often took longer than 8 mins now complete in under 100 ms.\n\n2. Improved peer management.\nFor example, `filter` nodes will now remove unreachable clients after a number of connection failures,\nwhereas they would previously keep accumulating dead peers.\n\n3. Improved disk usage.\n`nwaku` nodes that persist historical messages on disk now manage their own storage size based on the `--store-capacity`.\nThis can significantly improve node start-up times.\n\nMore stability issues may be addressed in future as `nwaku` matures,\nbut we've noticed a marked improvement in the reliability of running `nwaku` nodes.\nThese include environments where `nwaku` nodes are expected to run with a long uptime.\nVac currently operates two long-running fleets of `nwaku` nodes, `wakuv2.prod` and `wakuv2.test`,\nfor internal dogfooding and\nto serve as experimental bootstrapping nodes.\nStatus has also recently deployed similar fleets for production and testing based on `nwaku`.\nOur goal is to have `nwaku` be stable, performant and flexible enough\nto be an attractive option for operators to run and maintain their own Waku v2 nodes.\nSee also the [future work](#future-work) section below for more on our general goal of _`nwaku` for operators_.\n\n## 3. Improvements in interoperability\n\nWe've implemented several features that improve `nwaku`'s usability in different environments\nand its interoperability with other Waku v2 clients.\nOne major step forward here was adding support for both secure and unsecured WebSocket connections as `libp2p` transports.\nThis allows direct connectivity with `js-waku`\nand paves the way for native browser usage.\nWe've also added support for parsing and resolving DNS-type `multiaddrs`,\ni.e. multiaddress protocol schemes [`dns`, `dns4`, `dns6` and `dnsaddr`](https://github.com/multiformats/multiaddr/blob/b746a7d014e825221cc3aea6e57a92d78419990f/protocols.csv#L8-L11).\nA `nwaku` node can now also be [configured with its own IPv4 DNS domain name](https://github.com/status-im/nim-waku/tree/d2fccb5220144893f994a67f2cc26661247f101f/waku/v2#configuring-a-domain-name) \nallowing dynamic IP address allocation without impacting a node's reachability by its peers.\n\n## 4. Peer discovery\n\n_Peer discovery_ is the method by which nodes become aware of each otherâ€™s existence.\nThe question of peer discovery in a Waku v2 network has been a focus area since the protocol was first conceptualized.\nSince then several different approaches to discovery have been proposed and investigated.\nWe've implemented three discovery mechanisms in `nwaku` so far:\n\n### DNS-based discovery\n\n`nwaku` nodes can retrieve an authenticated, updateable list of peers via DNS to bootstrap connection to a Waku v2 network.\nOur implementation is based on [EIP-1459](https://eips.ethereum.org/EIPS/eip-1459).\n\n### GossipSub peer exchange\n\n[GossipSub Peer Exchange (PX)](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange) is a GossipSub v1.1 mechanism\nwhereby a pruning peer may provide a pruned peer with a set of alternative peers\nwhere it can connect to reform its mesh.\nThis is a very suitable mechanism to gradually discover more peers\nfrom an initial connection to a small set of bootstrap peers.\nIt is enabled in a `nwaku` node by default.\n\n### Waku Node Discovery Protocol v5\n\nThis is a DHT-based discovery mechanism adapted to store and relay _node records_.\nOur implementation is based on [Ethereum's Discovery v5 protocol](https://github.com/ethereum/devp2p/blob/fa6428ada7385c13551873b2ae6ad2457c228eb8/discv5/discv5-theory.md)\nwith some [minor modifications](https://rfc.vac.dev/spec/33/) to isolate our discovery network from that of Ethereum.\nThe decision to separate the Waku Discovery v5 network from Ethereum's was made on considerations of lookup efficiency.\nThis comes at a possible tradeoff in network resilience.\nWe are considering merging with the Ethereum Discovery v5 network in future,\nor even implement a hybrid solution.\n[This post](https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121/8) explains the decision and future steps.\n\n## 5. Spam protection using RLN\n\nAn early addition to our suite of protocols was [an extension of `11/WAKU-RELAY`](https://rfc.vac.dev/spec/32/)\nthat provided spam protection using [Rate Limiting Nullifiers (RLN)](https://rfc.vac.dev/spec/32/).\nThe `nwaku` client now contains a working demonstration and integration of RLN relay.\nCheck out [this tutorial](https://github.com/status-im/nim-waku/blob/ee96705c7fbe4063b780ac43b7edee2f6c4e351b/docs/tutorial/rln-chat2-live-testnet.md) to see the protocol in action using a toy chat application built on `nwaku`.\nWe'd love for people to join us in dogfooding RLN spam protection as part of our operator incentive testnet.\nFeel free to join our [Vac Discord](https://discord.gg/KNj3ctuZvZ) server\nand head to the `#rln` channel for more information.\n\n## Future work\n\nAs we continue working towards our goal of a fully decentralized, generalized and censorship-resistant messaging protocol,\nthese are some of the current and future focus areas for `nwaku`:\n\n### Reaching out to operators:\n\nWe are starting to push for operators to run and maintain their own Waku v2 nodes,\npreferably contributing to the default Waku v2 network as described by the default pubsub topic (`/waku/2/default-waku/proto`).\nAmongst other things, a large fleet of stable operator-run Waku v2 nodes will help secure the network,\nprovide valuable services to a variety of applications\nand ensure the future sustainability of both Vac as a research organization and the Waku suite of protocols.\n\nWe are targeting `nwaku` as the main option for operator-run nodes.  \nSpecifically, we aim to provide through `nwaku`:\n\n1.  a lightweight and robust Waku v2 client.\nThis client must be first in line to support innovative and new Waku v2 protocols,\nbut configurable enough to serve the adaptive needs of various operators.\n2.  an easy-to-follow guide for operators to configure,\nset up and maintain their own nodes\n3.  a set of operator-focused tools to monitor and maintain a running node\n\n### Better conversational security layer guarantees\n\nConversational security guarantees in Waku v2 are currently designed around the Status application.\nDevelopers building their own applications on top of Waku would therefore\neither have to reimplement a set of tools similar to Status\nor build their own security solutions on the application layer above Waku.\nWe are working on [a set of features](https://github.com/vacp2p/research/issues/97) built into Waku\nthat will provide the general security properties Waku users may desire\nand do so in a modern and simple way.\nThis is useful for applications outside of Status that want similar security guarantees.\nAs a first step, we've already made good progress toward [integrating noise handshakes](https://forum.vac.dev/t/noise-handshakes-as-key-exchange-mechanism-for-waku2/130) as a key exchange mechanism in Waku v2.\n\n### Protocol incentivization\n\nWe want to design incentivization around our protocols to encourage desired behaviors in the Waku network,\nrewarding nodes providing costly services\nand punishing adversarial actions.\nThis will increase the overall security of the network\nand encourage operators to run their own Waku nodes.\nIn turn, the sustainability of Vac as an organization will be better guaranteed.\nAs such, protocol incentivization was a major focus in our recent [Vac Sustainability and Business Workshop](https://forum.vac.dev/t/vac-sustainability-and-business-workshop/).\nOur first step here is to finish integrating RLN relay into Waku\nwith blockchain interaction to manage members,\npunish spammers\nand reward spam detectors.\nAfter this, we want to design monetary incentivization for providers of `store`, `lightpush` and `filter` services.\nThis may also tie into a reputation mechanism for service nodes based on a network-wide consensus on service quality.\nA big challenge for protocol incentivization is doing it in a private fashion,\nso we can keep similar metadata protection guarantees as the Waku base layer.\nThis ties into our focus on [Zero Knowledge tech](https://forum.vac.dev/t/vac-3-zk/97).\n\n### Improved store capacity\n\nThe `nwaku` store currently serves as an efficient in-memory store for historical messages,\ndimensioned by the maximum number of messages the store node is willing to keep.\nThis makes the `nwaku` store appropriate for keeping history over a short term\nwithout any time-based guarantees,\nbut with the advantage of providing fast responses to history queries.\nSome applications, such as Status, require longer-term historical message storage\nwith time-based dimensioning\nto guarantee that messages will be stored for a specified minimum period.\nBecause of the relatively high cost of memory compared to disk space,\na higher capacity store, with time guarantees, should operate as a disk-only database of historical messages.\nThis is an ongoing effort.\n\n### Multipurpose discovery\n\nIn addition to [the three discovery methods](#4-peer-discovery) already implemented in `nwaku`,\nwe are working on improving discovery on at least three fronts:\n\n#### _Capability discovery:_\n\nWaku v2 nodes may be interested in peers with specific capabilities, for example:\n\n1. peers within a specific pubsub topic mesh,\n2. peers with **store** capability,\n3. **store** peers with x days of history for a specific content topic, etc.\n\nCapability discovery entails mechanisms by which such capabilities can be advertised and discovered/negotiated.\nOne major hurdle to overcome is the increased complexity of finding a node with specific capabilities within the larger network (a needle in a haystack).\nSee the [original problem statement](https://github.com/vacp2p/rfc/issues/429) for more.\n\n#### _Improvements in Discovery v5_\n\nOf the implemented discovery methods,\nDiscovery v5 best addresses our need for a decentralized and scalable discovery mechanism.\nWith the basic implementation done,\nthere are some improvements planned for Discovery v5,\nincluding methods to increase security such as merging with the Ethereum Discovery v5 network,\nintroducing explicit NAT traversal\nand utilizing [topic advertisement](https://github.com/ethereum/devp2p/blob/fa6428ada7385c13551873b2ae6ad2457c228eb8/discv5/discv5-theory.md#topic-advertisement).\nThe [Waku v2 Discovery v5 Roadmap](https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121) contains more details.\n\n#### _Generalized peer exchange_\n\n`nwaku` already implements [GossipSub peer exchange](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange).\nWe now need a general request-response mechanism outside of GossipSub\nby which a node may learn about other Waku v2 nodes\nby requesting and receiving a list of peers from a neighbor.\nThis could, for example, be a suitable way for resource-restricted devices to request a stronger peer\nto perform a random Discovery v5 lookup on their behalf\nor simply to be informed of a subset of the peers known to that neighbor.\nSee [this issue](https://github.com/vacp2p/rfc/issues/495) for more.\n\n---\n\nThis concludes a general outline of some of the main recent developments in the `nwaku` client\nand a summary of the current and future focus areas.\nMuch more is happening behind the scenes, of course,\nso for more information, or to join the conversation,\nfeel free to join our [Vac Discord](https://discord.gg/KNj3ctuZvZ) server\nor to check out the [`nwaku` repo on Github](https://github.com/status-im/nim-waku).\nYou can also view the changelog for past releases [here](https://github.com/status-im/nim-waku/releases).\n\n## References\n\n- [17/WAKU-RLN-RELAY](https://rfc.vac.dev/spec/17/)\n- [32/RLN](https://rfc.vac.dev/spec/32/)\n- [33/WAKU2-DISCV5](https://rfc.vac.dev/spec/33/)\n- [Capabilities advertising](https://github.com/vacp2p/rfc/issues/429)\n- [Configuring a domain name](https://github.com/status-im/nim-waku/tree/d2fccb5220144893f994a67f2cc26661247f101f/waku/v2#configuring-a-domain-name)\n- [Conversational security](https://github.com/vacp2p/research/issues/97)\n- [Discovery v5 Topic Advertisement](https://github.com/ethereum/devp2p/blob/fa6428ada7385c13551873b2ae6ad2457c228eb8/discv5/discv5-theory.md#topic-advertisement)\n- [EIP-1459](https://eips.ethereum.org/EIPS/eip-1459)\n- [GossipSub Peer Exchange](https://github.com/libp2p/specs/blob/10712c55ab309086a52eec7d25f294df4fa96528/pubsub/gossipsub/gossipsub-v1.1.md#prune-backoff-and-peer-exchange)\n- [go-waku](https://github.com/status-im/go-waku)\n- [js-waku](https://github.com/status-im/js-waku)\n- [`multiaddr` formats](https://github.com/multiformats/multiaddr/blob/b746a7d014e825221cc3aea6e57a92d78419990f/protocols.csv#L8-L11)\n- [nimbus-eth2](https://github.com/status-im/nimbus-eth2)\n- [nim-libp2p](https://github.com/status-im/nim-libp2p)\n- [nim-waku](https://github.com/status-im/nim-waku)\n- [nim-waku releases](https://github.com/status-im/nim-waku/releases)\n- [Node Discovery Protocol v5 - Theory](https://github.com/ethereum/devp2p/blob/fa6428ada7385c13551873b2ae6ad2457c228eb8/discv5/discv5-theory.md)\n- [Noise handshakes](https://forum.vac.dev/t/noise-handshakes-as-key-exchange-mechanism-for-waku2/130)\n- [RLN tutorial](https://github.com/status-im/nim-waku/blob/ee96705c7fbe4063b780ac43b7edee2f6c4e351b/docs/tutorial/rln-chat2-live-testnet.md)\n- [Vac <3 ZK](https://forum.vac.dev/t/vac-3-zk/97)\n- [Vac About page](https://vac.dev/#about)\n- [Vac Research log](https://vac.dev/research-log/)\n- [Vac RFC site](https://rfc.vac.dev/)\n- [Vac Sustainability and Business Workshop](https://forum.vac.dev/t/vac-sustainability-and-business-workshop/)\n- [Waku Update](/waku-update)\n- [Waku v1 vs Waku v2: Bandwidth Comparison](/waku-v1-v2-bandwidth-comparison)\n- [Waku v2 Peer Exchange](https://github.com/vacp2p/rfc/issues/495)\n- [Waku v2 Discovery v5 Roadmap](https://forum.vac.dev/t/waku-v2-discv5-roadmap-discussion/121)\n- [What's the Plan for Waku v2?](/waku-v2-plan)\n","metadata":{"layout":"post","name":"Introducing nwaku","title":"Introducing nwaku","date":"2022-04-12T10:00:00.000Z","author":"hanno","published":true,"permalink":"/introducing-nwaku","categories":"research","summary":"Introducing nwaku, a Nim-based Waku v2 client, including a summary of recent developments and preview of current and future focus areas.","image":"/img/vac.png","discuss":"https://forum.vac.dev/"},"toc":[{"content":"Background","slug":"background","lvl":2,"i":0,"seen":0},{"content":"nim-waku_ is now known as nwaku_","slug":"nim-waku-is-now-known-as-nwaku","lvl":2,"i":1,"seen":0},{"content":"Improvements in stability and performance","slug":"improvements-in-stability-and-performance","lvl":2,"i":2,"seen":0},{"content":"Improvements in interoperability","slug":"improvements-in-interoperability","lvl":2,"i":3,"seen":0},{"content":"Peer discovery","slug":"peer-discovery","lvl":2,"i":4,"seen":0},{"content":"DNS-based discovery","slug":"dns-based-discovery","lvl":3,"i":5,"seen":0},{"content":"GossipSub peer exchange","slug":"gossip-sub-peer-exchange","lvl":3,"i":6,"seen":0},{"content":"Waku Node Discovery Protocol v5","slug":"waku-node-discovery-protocol-v5","lvl":3,"i":7,"seen":0},{"content":"Spam protection using RLN","slug":"spam-protection-using-rln","lvl":2,"i":8,"seen":0},{"content":"Future work","slug":"future-work","lvl":2,"i":9,"seen":0},{"content":"Reaching out to operators:","slug":"reaching-out-to-operators","lvl":3,"i":10,"seen":0},{"content":"Better conversational security layer guarantees","slug":"better-conversational-security-layer-guarantees","lvl":3,"i":11,"seen":0},{"content":"Protocol incentivization","slug":"protocol-incentivization","lvl":3,"i":12,"seen":0},{"content":"Improved store capacity","slug":"improved-store-capacity","lvl":3,"i":13,"seen":0},{"content":"Multipurpose discovery","slug":"multipurpose-discovery","lvl":3,"i":14,"seen":0},{"content":"Capability discovery:","slug":"capability-discovery","lvl":4,"i":15,"seen":0},{"content":"Improvements in Discovery v5","slug":"improvements-in-discovery-v5","lvl":4,"i":16,"seen":0},{"content":"Generalized peer exchange","slug":"generalized-peer-exchange","lvl":4,"i":17,"seen":0},{"content":"References","slug":"references","lvl":2,"i":18,"seen":0}]},"navProps":{"metadata":{"published":true,"title":"Introducing nwaku","layout":"post","name":"Introducing nwaku","date":"2022-04-12T10:00:00.000Z","author":"hanno","permalink":"/introducing-nwaku","categories":"research","summary":"Introducing nwaku, a Nim-based Waku v2 client, including a summary of recent developments and preview of current and future focus areas.","image":"img/vac.png","discuss":"https://forum.vac.dev/"},"navOrder":1649757600,"localPath":"research/2022-04-12-introducing-nwaku.md","path":["introducing-nwaku"],"children":[],"isDir":false},"routeParams":{"path":["introducing-nwaku"]}},"__N_SSG":true}